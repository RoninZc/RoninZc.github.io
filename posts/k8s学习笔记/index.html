<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>K8S学习笔记 - RoninZc 的个人记录</title><meta name="author" content="RoninZc">
<meta name="author-link" content="">
<meta name="description" content="这篇文章用作自己学习 k8s 的笔记，学习的资料为b站的视频 2021 年末倾力打造 Kubernetes 入门至精通 - 2022 年幸福的开胃菜_哔哩哔哩_bilibili 本文章为本人学习" /><meta name="keywords" content='k8s' />
  <meta itemprop="name" content="K8S学习笔记">
  <meta itemprop="description" content="这篇文章用作自己学习 k8s 的笔记，学习的资料为b站的视频 2021 年末倾力打造 Kubernetes 入门至精通 - 2022 年幸福的开胃菜_哔哩哔哩_bilibili 本文章为本人学习">
  <meta itemprop="datePublished" content="2022-06-07T10:45:00+08:00">
  <meta itemprop="dateModified" content="2022-06-07T10:45:00+08:00">
  <meta itemprop="wordCount" content="16033">
  <meta itemprop="image" content="https://ronin-zc.com/logo.png">
  <meta itemprop="keywords" content="K8s"><meta property="og:url" content="https://ronin-zc.com/posts/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">
  <meta property="og:site_name" content="RoninZc 的个人记录">
  <meta property="og:title" content="K8S学习笔记">
  <meta property="og:description" content="这篇文章用作自己学习 k8s 的笔记，学习的资料为b站的视频 2021 年末倾力打造 Kubernetes 入门至精通 - 2022 年幸福的开胃菜_哔哩哔哩_bilibili 本文章为本人学习">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-06-07T10:45:00+08:00">
    <meta property="article:modified_time" content="2022-06-07T10:45:00+08:00">
    <meta property="article:tag" content="K8s">
    <meta property="og:image" content="https://ronin-zc.com/logo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="https://ronin-zc.com/logo.png">
  <meta name="twitter:title" content="K8S学习笔记">
  <meta name="twitter:description" content="这篇文章用作自己学习 k8s 的笔记，学习的资料为b站的视频 2021 年末倾力打造 Kubernetes 入门至精通 - 2022 年幸福的开胃菜_哔哩哔哩_bilibili 本文章为本人学习">
<meta name="application-name" content="RoninZc的个人记录">
<meta name="apple-mobile-web-app-title" content="RoninZc的个人记录"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://ronin-zc.com/posts/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><link rel="prev" href="https://ronin-zc.com/posts/%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94%E8%BD%AC%E8%BD%BD/" /><link rel="next" href="https://ronin-zc.com/posts/docker%E9%83%A8%E7%BD%B2nginx%E5%87%BA%E7%8E%B0host-not-found-in-upstream%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "K8S学习笔记",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/ronin-zc.com\/posts\/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0\/"
    },"genre": "posts","keywords": "k8s","wordcount":  16033 ,
    "url": "https:\/\/ronin-zc.com\/posts\/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0\/","datePublished": "2022-06-07T10:45:00+08:00","dateModified": "2022-06-07T10:45:00+08:00","license": "1","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "RoninZc"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper" data-github-corner="right">
    <div class="header-title">
      <a href="/" title="RoninZc 的个人记录"><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/07/25/62de10979d4e1.jpg" alt="RoninZc 的个人记录" data-title="RoninZc 的个人记录" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">RoninZc</span></a><span id="typeit-header-subtitle-desktop" class="typeit header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="RoninZc 的个人记录"><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/07/25/62de10979d4e1.jpg" alt="https://lsky.ronin-zc.com/i/2022/07/25/62de10979d4e1.jpg" data-title="https://lsky.ronin-zc.com/i/2022/07/25/62de10979d4e1.jpg" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">RoninZc</span></a><span id="typeit-header-subtitle-mobile" class="typeit header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><nav aria-label="breadcrumb" class="breadcrumb-container sticky">
    <ol class="breadcrumb"><li class="breadcrumb-item"><a href="/" title="RoninZc 的个人记录">主页</a></li><li class="breadcrumb-item"><a href="/posts/" title="Posts">文章</a></li><li class="breadcrumb-item active" aria-current="page">K8S学习笔记</li>
    </ol>
  </nav><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>K8S学习笔记</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/07/25/62de10979d4e1.jpg" alt="RoninZc" data-title="RoninZc" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;RoninZc</span></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/%E5%AD%A6%E4%B9%A0/" class="post-category" title="分类 - 学习"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 学习</a></span></div><div class="post-meta-line"><span title="发布于 2022-06-07 10:45:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2022-06-07">2022-06-07</time></span>&nbsp;<span title="16033 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 16100 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 33 分钟</span>&nbsp;<span id="busuanzi_container_page_pv" class="busuanzi_visitors comment-visitors" data-flag-title="K8S学习笔记">
              <i class="fa-regular fa-eye fa-fw me-1" aria-hidden="true"></i><span id="busuanzi_value_page_pv">-</span>&nbsp;次阅读
            </span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1基础概念">1、基础概念</a></li>
    <li><a href="#2pod">2、Pod</a>
      <ul>
        <li><a href="#pod种类">Pod种类</a></li>
        <li><a href="#控制器种类">控制器种类</a>
          <ul>
            <li><a href="#replication-controller-rc-replicasetrs--deployment">Replication Controller （RC）&amp; ReplicaSet（RS） &amp; Deployment</a>
              <ul>
                <li><a href="#滚动更新">滚动更新</a></li>
                <li><a href="#hpahorizontalpodautoscale自动扩缩容">HPA（HorizontalPodAutoScale）自动扩缩容</a></li>
              </ul>
            </li>
            <li><a href="#statefulset">StatefulSet</a></li>
            <li><a href="#daemonset">DaemonSet</a></li>
            <li><a href="#job--cronjob">Job &amp; cronJob</a></li>
          </ul>
        </li>
        <li><a href="#网络模型">网络模型</a>
          <ul>
            <li><a href="#flannel">Flannel</a></li>
            <li><a href="#网络通讯模式">网络通讯模式</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#3k8s安装">3、K8S安装</a>
      <ul>
        <li><a href="#前置准备">前置准备</a></li>
        <li><a href="#安装-kubernetes">安装 Kubernetes</a>
          <ul>
            <li><a href="#1安装容器组件">1、安装容器组件</a></li>
            <li><a href="#2安装-kubeadm-主从配置">2、安装 Kubeadm （主从配置）</a></li>
            <li><a href="#3初始化主节点">3、初始化主节点</a></li>
            <li><a href="#4工作节点加入">4、工作节点加入</a></li>
            <li><a href="#5工作节点退出">5、工作节点退出</a></li>
            <li><a href="#6创建网络flannel">6、创建网络「flannel」</a></li>
            <li><a href="#7集群测试">7、集群测试</a>
              <ul>
                <li><a href="#71创建pod">7.1、创建pod</a></li>
                <li><a href="#72创建-svc-网络">7.2、创建 svc 网络</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#4资源清单">4、资源清单</a>
      <ul>
        <li><a href="#格式">格式</a></li>
        <li><a href="#常用命令">常用命令</a>
          <ul>
            <li><a href="#获取-apiversion-版本信息">获取 apiversion 版本信息</a></li>
            <li><a href="#字段配置格式">字段配置格式</a></li>
          </ul>
        </li>
        <li><a href="#通过定义清单文件创建-pod">通过定义清单文件创建 Pod</a></li>
      </ul>
    </li>
    <li><a href="#5pod-生命周期">5、Pod 生命周期</a>
      <ul>
        <li><a href="#执行流程">执行流程</a></li>
        <li><a href="#init-容器">init 容器</a></li>
        <li><a href="#简单实操">简单实操</a></li>
        <li><a href="#探针">探针</a>
          <ul>
            <li><a href="#readinessprobe就绪探针"><strong>readinessProbe「就绪探针」</strong></a></li>
            <li><a href="#livenessprobe存活探针"><strong>livenessProbe「存活探针」</strong></a></li>
          </ul>
        </li>
        <li><a href="#启动退出动作hook">启动、退出动作「hook」</a></li>
      </ul>
    </li>
    <li><a href="#6控制器详解">6、控制器详解</a>
      <ul>
        <li><a href="#rc-控制器">RC 控制器</a></li>
        <li><a href="#rs-控制器">RS 控制器</a>
          <ul>
            <li><a href="#示例">示例</a></li>
          </ul>
        </li>
        <li><a href="#deployment-控制器">Deployment 控制器</a>
          <ul>
            <li><a href="#1部署一个简单的-nginx-应用">1、部署一个简单的 Nginx 应用</a></li>
            <li><a href="#2扩容">2、扩容</a></li>
            <li><a href="#3更新镜像">3、更新镜像</a></li>
            <li><a href="#4回滚">4、回滚</a></li>
            <li><a href="#5更新策略">5、更新策略</a></li>
            <li><a href="#6金丝雀部署">6、金丝雀部署</a></li>
          </ul>
        </li>
        <li><a href="#daemonset-1">DaemonSet</a></li>
        <li><a href="#job">Job</a></li>
        <li><a href="#cronjob">CronJob</a></li>
      </ul>
    </li>
    <li><a href="#7service">7、Service</a>
      <ul>
        <li><a href="#核心迭代">核心迭代</a>
          <ul>
            <li><a href="#1userspace-代理模式">1、userspace 代理模式</a></li>
            <li><a href="#2iptables-代理模式">2、iptables 代理模式</a></li>
            <li><a href="#3ipvs-代理模式">3、ipvs 代理模式</a></li>
          </ul>
        </li>
        <li><a href="#限制">限制</a></li>
        <li><a href="#类型">类型</a>
          <ul>
            <li><a href="#1clusterip">1、ClusterIP</a></li>
            <li><a href="#2nodeport">2、NodePort</a></li>
            <li><a href="#3loadbalancer">3、LoadBalancer</a></li>
            <li><a href="#4externalname">4、ExternalName</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#8ingress">8、Ingress</a>
      <ul>
        <li><a href="#实现原理">实现原理</a></li>
        <li><a href="#示例-1">示例</a>
          <ul>
            <li><a href="#http代理">http代理</a></li>
            <li><a href="#https代理">https代理</a></li>
            <li><a href="#basicauth">BasicAuth</a></li>
            <li><a href="#nginx-进行重写">Nginx 进行重写</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#9存储">9、存储</a>
      <ul>
        <li><a href="#configmap">ConfigMap</a>
          <ul>
            <li><a href="#描述">描述</a></li>
            <li><a href="#创建">创建</a></li>
            <li><a href="#使用">使用</a>
              <ul>
                <li><a href="#使用-configmap-来代替环境变量">使用 ConfigMap 来代替环境变量</a></li>
                <li><a href="#使用-configmap-设置命令行参数">使用 ConfigMap 设置命令行参数</a></li>
                <li><a href="#通过数据卷插件使用-configmap">通过数据卷插件使用 ConfigMap</a></li>
                <li><a href="#热更新">热更新</a></li>
                <li><a href="#滚动更新pod">滚动更新Pod</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#secret">Secret</a>
          <ul>
            <li><a href="#service-account">Service Account</a></li>
            <li><a href="#opaque-secret">Opaque Secret</a>
              <ul>
                <li><a href="#创建-1">创建</a></li>
                <li><a href="#使用-1">使用</a></li>
              </ul>
            </li>
            <li><a href="#kubernetesiodockerconfigjson">kubernetes.io/dockerconfigjson</a></li>
          </ul>
        </li>
        <li><a href="#volume卷">Volume「卷」</a>
          <ul>
            <li>
              <ul>
                <li><a href="#emptydir">emptyDir</a></li>
                <li><a href="#hostpath">hostPath</a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#persistent-volume持久卷">Persistent Volume「持久卷」</a>
          <ul>
            <li><a href="#概念">概念</a></li>
            <li><a href="#绑定">绑定</a></li>
            <li><a href="#保护">保护</a></li>
            <li><a href="#分类">分类</a></li>
            <li><a href="#访问模式">访问模式</a></li>
            <li><a href="#回收策略">回收策略</a></li>
            <li><a href="#状态">状态</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><blockquote>
<p>这篇文章用作自己学习 k8s 的笔记，学习的资料为b站的视频</p>
<p><a href="https://www.bilibili.com/video/BV1Hq4y1y7rL"target="_blank" rel="external nofollow noopener noreferrer">2021 年末倾力打造 Kubernetes 入门至精通 - 2022 年幸福的开胃菜_哔哩哔哩_bilibili<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></p>
<p>本文章为本人学习所用，如需转载请注明出处</p>
</blockquote>
<h2 id="1基础概念" class="heading-element">
  <a href="#1%e5%9f%ba%e7%a1%80%e6%a6%82%e5%bf%b5" class="heading-mark"></a>1、基础概念</h2><p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc9679349bf.png" alt="image-20220511143900784.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc9679349bf.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc9679349bf.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc9679349bf.png?size=large 2x" data-title="image-20220511143900784.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<ul>
<li>基础组件
<ol>
<li>kubectl</li>
<li>api server</li>
<li>scheduler</li>
<li>replication controller</li>
<li>etcd</li>
<li>kubelet</li>
<li>kube proxy</li>
<li>firewall</li>
</ol>
</li>
<li>插件
<ol>
<li>CoreDNS 负责为整个集群提供 DNS 服务</li>
<li>Ingress Controller 为 k8s 中的服务提供外网入口</li>
<li>Prometheus 为整个集群提供资源监控能力，时序数据库</li>
<li>Dashboard 提供 B/S 的访问体系，允许用户通过 web 进行集群管理和设置，比较常用的如：rancher</li>
<li>Federation 提供跨可用区的集群，提供不同数据中心的 K8S 集群的管理能力</li>
</ol>
</li>
</ul>
<h2 id="2pod" class="heading-element">
  <a href="#2pod" class="heading-mark"></a>2、Pod</h2><p>在下达创建 pod 的时候，第一个被初始化的容器为<code>pause</code>，作用为初始化网络栈，挂载存储卷等。后续继续创建对应的 container，这些创建的 container 都会与初始容器<code>pause</code> 共享网络栈和存储等，类似 docker 中的<code>--net</code>和<code>--volumes-from</code>。这样在一个 Pod 中的 container 可以直接通过回环接口相互访问。</p>
<h3 id="pod种类" class="heading-element">
  <a href="#pod%e7%a7%8d%e7%b1%bb" class="heading-mark"></a>Pod种类</h3><ol>
<li>
<p>自主式 Pod</p>
</li>
<li>
<p>控制器管理的 Pod（推荐）</p>
<ul>
<li>ReplicationController &amp; ReplicaSet &amp; Deployment
<ul>
<li>HPA（HorizontalPodAutoScale）</li>
</ul>
</li>
<li>StatefullSet</li>
<li>DarmonSet</li>
<li>Job &amp; Cronjob</li>
<li>自定义控制器&hellip; 不做讨论</li>
</ul>
</li>
</ol>
<h3 id="控制器种类" class="heading-element">
  <a href="#%e6%8e%a7%e5%88%b6%e5%99%a8%e7%a7%8d%e7%b1%bb" class="heading-mark"></a>控制器种类</h3><h4 id="replication-controller-rc-replicasetrs--deployment" class="heading-element">
  <a href="#replication-controller-rc-replicasetrs--deployment" class="heading-mark"></a>Replication Controller （RC）&amp; ReplicaSet（RS） &amp; Deployment</h4><p>用来确保容器应用的副本数始终保持在用户定义的副本数，即如果有容器异常退出，会自动创建新的 Pod 来替代，而如果异常多出的容器也会自动回收。</p>
<p>在新版本的 K8S 中建议使用 RS 来取代 RC。</p>
<p>RS 的本质和 RC 没有本质区别，只是名字不一样，并且 RS 支持集合式的标签选择器（tag selector）。</p>
<p>虽然 RS 可以独立使用，但是一般建议使用 Deployment 来自动管理 RS，这样可以无需担心和其他机制不兼容的问题。比如 RS 不支持滚动更新（rolling-update）但 Deployment 支持。</p>
<h5 id="滚动更新" class="heading-element">
  <a href="#%e6%bb%9a%e5%8a%a8%e6%9b%b4%e6%96%b0" class="heading-mark"></a>滚动更新</h5><div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 更新前</span>
</span></span><span class="line"><span class="cl">Deployment「Pod模板:v1，副本数量：3」
</span></span><span class="line"><span class="cl">└─ RS「副本数量：3」
</span></span><span class="line"><span class="cl">		├─ Pod:v1
</span></span><span class="line"><span class="cl">		├─ Pod:v1
</span></span><span class="line"><span class="cl">		└─ Pod:v1
</span></span><span class="line"><span class="cl"><span class="c1"># 更新Pod模板:v2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 更新中：</span>
</span></span><span class="line"><span class="cl">Deployment「Pod模板:v1，副本数量：3」
</span></span><span class="line"><span class="cl">├─ RS「副本数量：2」
</span></span><span class="line"><span class="cl">│  ├── Pod:v1
</span></span><span class="line"><span class="cl">│  └── Pod:v1
</span></span><span class="line"><span class="cl">└─ RS「副本数量：1」
</span></span><span class="line"><span class="cl">	 └─ Pod:v2
</span></span><span class="line"><span class="cl"><span class="c1"># 更新完毕：</span>
</span></span><span class="line"><span class="cl">Deployment「Pod模板:v1，副本数量：3」
</span></span><span class="line"><span class="cl">├─ RS「副本数量：0」
</span></span><span class="line"><span class="cl">└─ RS「副本数量：3」
</span></span><span class="line"><span class="cl">		├─ Pod:v2
</span></span><span class="line"><span class="cl">		├─ Pod:v2
</span></span><span class="line"><span class="cl">		└─ Pod:v2
</span></span><span class="line"><span class="cl">	 </span></span></code></pre></td></tr></table>
</div>
</div><p>滚动更新会创建一个新的 RS 控制器，以此来创建新版本的 Pod，此时把老版本的 RS 控制器的期望数量一个个调整至0，这样就完成了滚动更新。</p>
<h5 id="hpahorizontalpodautoscale自动扩缩容" class="heading-element">
  <a href="#hpahorizontalpodautoscale%e8%87%aa%e5%8a%a8%e6%89%a9%e7%bc%a9%e5%ae%b9" class="heading-mark"></a>HPA（HorizontalPodAutoScale）自动扩缩容</h5><p>可以根据 Pod 的资源使用情况，调整副本数量，依赖于 RC、RS、Deployment 之上</p>
<h4 id="statefulset" class="heading-element">
  <a href="#statefulset" class="heading-mark"></a>StatefulSet</h4><blockquote>
<p>服务分类</p>
<ul>
<li>有状态的服务</li>
<li>无状态服务</li>
<li>中心化服务</li>
<li>去中心化服务</li>
</ul>
</blockquote>
<p>为了解决有状态服务的问题而设计出来，可用来有序扩容缩，其应用场景包括：</p>
<ul>
<li>稳定的持久化存储，即 Pod 重新调度后还是能访问到相同的持久化数据，基于 PVC 实现</li>
<li>稳定的网络标志，即 Pod 重新调度后，其 PodName 和 HostName 不变，基于 Headless Service（即没有 Cluster IP 的 Service）实现</li>
<li>有序部署，有序扩展，即 Pod 是有顺序的，在部署或者扩展的时候要依据定义的顺序依次进行（即从 0 到 N-1，在下一个 Pod 运行之前，所有之前的 Pod 必须都是 Running 和 Ready 状态），基于 init containers 来实现</li>
<li>有序收缩，有序删除（即 N-1到 0）</li>
</ul>
<h4 id="daemonset" class="heading-element">
  <a href="#daemonset" class="heading-mark"></a>DaemonSet</h4><p>确保全部（或者一些）Node 上运行一个 Pod 的副本。当有 Node 加入集群时，也会为他们新增一个 Pod。当有 Node 从集群移除时，这些 Pod 也会被回收。删除 DaemonSet 将会删除所有由它创建的 Pod</p>
<p>经典用法：</p>
<ul>
<li>运行集群存储 daemon，例如在每个 Node 上运行 glusterd，ceph</li>
<li>在每个 Node 上运行日志手机 deamon，例如 fluentd，logstash</li>
<li>在每个 Node 上运行监控 deamon，例如 Prometheus Node Exporter</li>
</ul>
<h4 id="job--cronjob" class="heading-element">
  <a href="#job--cronjob" class="heading-mark"></a>Job &amp; cronJob</h4><p>Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束</p>
<p>Cron Job 管理基于时间的 Job，即：</p>
<ul>
<li>在给定时间点只运行一次</li>
<li>周期性的在给定时间点运行</li>
</ul>
<h3 id="网络模型" class="heading-element">
  <a href="#%e7%bd%91%e7%bb%9c%e6%a8%a1%e5%9e%8b" class="heading-mark"></a>网络模型</h3><p>K8S 的网络模型假定了所有 Pod 都在一个可以直接连通的扁平的网络空间中，这在 GCE（Google Compute Engine）里面是现成的网络模型，K8S 假定这个网络已经存在。而在私有云里搭建 K8S 集群，就不能假定这个网络已经存在了。我们需要<strong>自己实现</strong>这个网络假设，将不同节点上的 Docker 容器之间的互相访问先打通，然后运行 K8S。</p>
<h4 id="flannel" class="heading-element">
  <a href="#flannel" class="heading-mark"></a>Flannel</h4><p>Flannel 是 CoreOS 团队针对 Kubernetes 设计的一个网络规划服务，简单来说，它的功能是让集群中的不同节点主机创建的 Docker 容器都具有<strong>全集群唯一</strong>的虚拟 IP 地址。而且它还能在这些 IP 地址之间建立一个覆盖网络（Overlay Network），通过这个覆盖网络，将数据包原封不动地传输到目标容器内。基于 etcd 实现。</p>
<p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967966952.png" alt="image-20220511161041771.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967966952.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967966952.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967966952.png?size=large 2x" data-title="image-20220511161041771.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>实现步骤：</p>
<ol>
<li>Flanneld 向 etcd 申请当前 Pod 的网段，修改当前 Docker0 的IP
<ul>
<li>会带上当前机器的物理网卡地址，这样就在 etcd 里标识了虚拟网段与真实IP之间的关系</li>
<li>当一个 Pod 发送网络数据的时候，通过对方的虚拟IP就可以找到真实IP了</li>
</ul>
</li>
<li>请求流转（根据图观察）
<ol>
<li>app2 发送一个数据包给<code>10.1.20.3</code>，发现无法直接访问，数据包传递给网关</li>
<li>此时数据包被 Flanneld 所捕获（Flannel0 监听的为 10.1.15.0，注意这个0）传递给对应的另外一个 Flanneld（从etcd获取）
<ul>
<li>此时 Flanneld 会对数据包进行二次封装，类似一个快递里是另外一个快递</li>
</ul>
</li>
<li>接收到数据包后进行拆包，在对应的 Docker0 中广播，这样也就能收到了</li>
</ol>
</li>
<li>回应同理</li>
</ol>
<h4 id="网络通讯模式" class="heading-element">
  <a href="#%e7%bd%91%e7%bb%9c%e9%80%9a%e8%ae%af%e6%a8%a1%e5%bc%8f" class="heading-mark"></a>网络通讯模式</h4><ul>
<li>同 Pod 间不同容器间的网络通讯：本地回环</li>
<li>不同 Pod 间的通讯
<ul>
<li>同物理机：Docker0 网桥实现报文转发</li>
<li>不同物理机：flannel UDP 数据包二次封装</li>
</ul>
</li>
<li>svc 网络与 Pod 间的通讯</li>
<li>隔离：namespace network</li>
</ul>
<h2 id="3k8s安装" class="heading-element">
  <a href="#3k8s%e5%ae%89%e8%a3%85" class="heading-mark"></a>3、K8S安装</h2><h3 id="前置准备" class="heading-element">
  <a href="#%e5%89%8d%e7%bd%ae%e5%87%86%e5%a4%87" class="heading-mark"></a>前置准备</h3><ol>
<li>
<p>安装配置</p>
<ul>
<li>推荐安装在单网卡机器</li>
<li>CPU &gt;= 2，内存 3G 以上，磁盘 100G</li>
<li>关闭 SWAP</li>
<li>分区
<ul>
<li>/boot 800m</li>
<li>/ 全部</li>
</ul>
</li>
<li>seliunx，firewall stop，iptable none</li>
</ul>
</li>
<li>
<p>K8S安装3个节点，可以配置一个软路由，双网卡</p>
<ul>
<li>网卡1: 仅主机</li>
<li>网卡2: NAT 上网</li>
</ul>
</li>
<li>
<p>安装工具包（可选）</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt-get install -y conntrack ntpdate ntp ipvsadm ipset iptables curl sysstat  wget net-tools git</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>同步时区</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo apt install ntpdate
</span></span><span class="line"><span class="cl">sudo ntpdate ntp.aliyun.com</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>关闭<code>swap</code></p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo swapoff -a <span class="c1"># 临时关闭</span>
</span></span><span class="line"><span class="cl">sed -ri <span class="s1">&#39;s/.swap./#&amp;/&#39;</span> /etc/fstab <span class="c1"># 永久关闭</span></span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>允许 iptables 桥接流量</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span></span></span><span class="line"><span class="cl"><span class="s">br_netfilter
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat <span class="s">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class="line"><span class="cl"><span class="s">EOF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置网卡允许转发 ipv4 流量</span>
</span></span><span class="line"><span class="cl">sudo sysctl -w net.ipv4.ip_forward<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sudo sysctl --system</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h3 id="安装-kubernetes" class="heading-element">
  <a href="#%e5%ae%89%e8%a3%85-kubernetes" class="heading-mark"></a>安装 Kubernetes</h3><ul>
<li>源码包编译安装（难度过高）
<ul>
<li>可参考<a href="https://cloudmessage.top/archives/2kubernetes%e5%ae%89%e8%a3%85md"target="_blank" rel="external nofollow noopener noreferrer">Kubernetes - 二进制版本安装 - v1.18 (cloudmessage.top)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
</li>
<li>容器化安装
<ul>
<li>kubeadm 官方
<ul>
<li>证书有效期 1 年（需要修改源码，设置生成证书有效时间）</li>
</ul>
</li>
<li>rancher</li>
<li>sealos</li>
</ul>
</li>
</ul>
<h4 id="1安装容器组件" class="heading-element">
  <a href="#1%e5%ae%89%e8%a3%85%e5%ae%b9%e5%99%a8%e7%bb%84%e4%bb%b6" class="heading-mark"></a>1、安装容器组件</h4><ul>
<li>docker
<ul>
<li><a href="../ubuntu-arm-docker-%e5%ae%89%e8%a3%85/">ARM 系统安装</a></li>
<li>X86_64 可参考上文，注意修改对应系统架构即可</li>
</ul>
</li>
<li>containerd k8s v1.24.0后 <a href="../k8sv1.24.0-containerd%e5%ae%89%e8%a3%85%e6%95%99%e7%a8%8b">K8Sv1.24.0-containerd安装教程</a></li>
</ul>
<h4 id="2安装-kubeadm-主从配置" class="heading-element">
  <a href="#2%e5%ae%89%e8%a3%85-kubeadm-%e4%b8%bb%e4%bb%8e%e9%85%8d%e7%bd%ae" class="heading-mark"></a>2、安装 Kubeadm （主从配置）</h4><blockquote>
<p>Kubeadm 启动流程</p>
<p>Master
Systemd &gt; kubelet &gt; 容器组件 &gt; Kubernetes</p>
<p>容器组件在 k8s v1.24.0 版本已弃用 Docker shim
使用了新组件 CRI DOCKERD</p>
</blockquote>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 添加阿里云镜像源</span>
</span></span><span class="line"><span class="cl">sudo apt update <span class="o">&amp;&amp;</span> sudo apt install -y apt-transport-https
</span></span><span class="line"><span class="cl">sudo curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg <span class="p">|</span> sudo apt-key add - 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加阿里云或者官方 api 源</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 阿里云</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main&#34;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span class="line"><span class="cl"><span class="c1"># 官方</span>
</span></span><span class="line"><span class="cl">sudo curl -o /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg 
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> <span class="p">|</span> sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 安装软件</span>
</span></span><span class="line"><span class="cl">sudo apt update <span class="o">&amp;&amp;</span> sudo apt install -y kubelet kubeadm kubectl
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 开机自启</span>
</span></span><span class="line"><span class="cl">systemctl <span class="nb">enable</span> kubelet.service
</span></span><span class="line"><span class="cl"><span class="c1"># 注意，此时可能 kublet 没正常运行，不用管继续往下走</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3初始化主节点" class="heading-element">
  <a href="#3%e5%88%9d%e5%a7%8b%e5%8c%96%e4%b8%bb%e8%8a%82%e7%82%b9" class="heading-mark"></a>3、初始化主节点</h4><div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 打印 kubeadm 默认配置</span>
</span></span><span class="line"><span class="cl">sudo kubeadm config print init-defaults &gt; kubeadm-config.yaml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改：`localAPIEndpoint.advertiseAddress`的值为当前主节点的 ip 地址</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">localAPIEndpoint:
</span></span><span class="line"><span class="cl">  advertiseAddress: 1.2.3.4 <span class="c1"># 这里</span>
</span></span><span class="line"><span class="cl">  bindPort: <span class="m">6443</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改：`nodeRegistration.name` 的值为当前主节点名称</span>
</span></span><span class="line"><span class="cl">···
</span></span><span class="line"><span class="cl">nodeRegistration:
</span></span><span class="line"><span class="cl">  criSocket: unix:///var/run/containerd/containerd.sock
</span></span><span class="line"><span class="cl">  imagePullPolicy: IfNotPresent
</span></span><span class="line"><span class="cl">  name: k8s-master01 <span class="c1"># 这里</span>
</span></span><span class="line"><span class="cl">  taints: null
</span></span><span class="line"><span class="cl">···
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加 Pod 网段，Flannel 需要工作在指定的网段</span>
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">networking:
</span></span><span class="line"><span class="cl">  dnsDomain: cluster.local
</span></span><span class="line"><span class="cl">  serviceSubnet: 10.96.0.0/12
</span></span><span class="line"><span class="cl">  podSubnet: 10.244.0.0/16 <span class="c1"># 新增该行</span>
</span></span><span class="line"><span class="cl">···
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 设置负载均衡方式为 ipvs（可选），下列配置添加到末尾，注意 --- 也需要添加</span>
</span></span><span class="line"><span class="cl">···
</span></span><span class="line"><span class="cl">---
</span></span><span class="line"><span class="cl">apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span class="line"><span class="cl">kind: KubeProxyConfiguration
</span></span><span class="line"><span class="cl">featureGates:
</span></span><span class="line"><span class="cl">	SupportIPVSProxyMode: <span class="nb">true</span>
</span></span><span class="line"><span class="cl">mode: ipvs
</span></span><span class="line"><span class="cl">···
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># k8s.gcr.io 国内无法直接访问，所以替换为阿里云镜像地址</span>
</span></span><span class="line"><span class="cl">sed -i <span class="s1">&#39;s/k8s.gcr.io/registry.cn-hangzhou.aliyuncs.com\/google_containers/g&#39;</span> kubeadm-config.yaml
</span></span><span class="line"><span class="cl"><span class="c1"># 配置文件准备完毕，开始初始化</span>
</span></span><span class="line"><span class="cl">sudo kubeadm init --config<span class="o">=</span>kubeadm-config.yaml --ignore-preflight-errors<span class="o">=</span>all --v<span class="o">=</span><span class="m">5</span> <span class="p">|</span> tee kubeadm-init.log
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 初始化成功根据页面提示</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># 非 root 用户</span>
</span></span><span class="line"><span class="cl">  mkdir -p <span class="nv">$HOME</span>/.kube
</span></span><span class="line"><span class="cl">  sudo cp -i /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">  sudo chown <span class="k">$(</span>id -u<span class="k">)</span>:<span class="k">$(</span>id -g<span class="k">)</span> <span class="nv">$HOME</span>/.kube/config
</span></span><span class="line"><span class="cl">  <span class="c1"># root 用户</span>
</span></span><span class="line"><span class="cl">  <span class="nb">export</span> <span class="nv">KUBECONFIG</span><span class="o">=</span>/etc/kubernetes/admin.conf
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看集群信息</span>
</span></span><span class="line"><span class="cl">kubectl cluster-info</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4工作节点加入" class="heading-element">
  <a href="#4%e5%b7%a5%e4%bd%9c%e8%8a%82%e7%82%b9%e5%8a%a0%e5%85%a5" class="heading-mark"></a>4、工作节点加入</h4><div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 在初始化主节点成功后，打印出的日志内的最后一段，告诉了我们应该如何加入一个主节点</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 也可以 cat kubeadm-init.log 查看</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 加入前查看当前主机名称 hostnamectl，可以修改为自己便于识别的名称</span>
</span></span><span class="line"><span class="cl">sudo hostnamectl set-hostname k8s-node01 --static
</span></span><span class="line"><span class="cl"><span class="c1"># 加入节点</span>
</span></span><span class="line"><span class="cl">sudo kubeadm join 192.168.31.100:6443 --token xxx.xxx <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        --discovery-token-ca-cert-hash sha256:xxx
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果提示 unable to fetch the kubeadm-config ConfigMap: faild to get config map: Unauthorized</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这个代表 token 过期，重新生成即可</span>
</span></span><span class="line"><span class="cl">sudo kubeadm token create --ttl <span class="m">0</span> --print-join-command
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果提示</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [kubelet-check] Initial timeout of 40s passed.</span>
</span></span><span class="line"><span class="cl"><span class="c1"># error execution phase kubelet-start: error uploading crisocket: timed out waiting for the condition</span>
</span></span><span class="line"><span class="cl"><span class="c1"># To see the stack trace of this error execute with --v=5 or higher</span>
</span></span><span class="line"><span class="cl">sudo kubeadm reset -f</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="5工作节点退出" class="heading-element">
  <a href="#5%e5%b7%a5%e4%bd%9c%e8%8a%82%e7%82%b9%e9%80%80%e5%87%ba" class="heading-mark"></a>5、工作节点退出</h4><div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 1、将节点设置为维护模式</span>
</span></span><span class="line"><span class="cl">kubectl drain k8s-node01 --delete-local-data --force --ignore-daemonsets node/k8s-node01
</span></span><span class="line"><span class="cl"><span class="c1"># 2、删除节点</span>
</span></span><span class="line"><span class="cl">kubectl delete node k8s-node01
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 登陆上节点机器</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 3、停止 kubelet</span>
</span></span><span class="line"><span class="cl">systemctl stop kubelet
</span></span><span class="line"><span class="cl"><span class="c1"># 4、k8s 重置</span>
</span></span><span class="line"><span class="cl">sudo kubeadm reset -f</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="6创建网络flannel" class="heading-element">
  <a href="#6%e5%88%9b%e5%bb%ba%e7%bd%91%e7%bb%9cflannel" class="heading-mark"></a>6、创建网络「flannel」</h4><div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 拷贝配置文件</span>
</span></span><span class="line"><span class="cl">sudo mkdir -p /usr/local/kubernetes/cni/flannel/
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /usr/local/kubernetes/cni/flannel/
</span></span><span class="line"><span class="cl">wget https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 应用配置</span>
</span></span><span class="line"><span class="cl">kubectl apply -f kube-flannel.yml
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 等待2～3分钟，查看是否成功</span>
</span></span><span class="line"><span class="cl">kubectl get nodes
</span></span><span class="line"><span class="cl"><span class="c1"># 可以看到所有节点都显示 ready</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="7集群测试" class="heading-element">
  <a href="#7%e9%9b%86%e7%be%a4%e6%b5%8b%e8%af%95" class="heading-mark"></a>7、集群测试</h4><h5 id="71创建pod" class="heading-element">
  <a href="#71%e5%88%9b%e5%bb%bapod" class="heading-mark"></a>7.1、创建pod</h5><div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建一个 deployment 任务 指定镜像</span>
</span></span><span class="line"><span class="cl">kubectl create deployment nginx --image<span class="o">=</span>nginx
</span></span><span class="line"><span class="cl"><span class="c1"># 获取 pod 列表</span>
</span></span><span class="line"><span class="cl">kubectl get po -o wide</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc96799f01b.png" alt="image-20220516143518665.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc96799f01b.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc96799f01b.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc96799f01b.png?size=large 2x" data-title="image-20220516143518665.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h5 id="72创建-svc-网络" class="heading-element">
  <a href="#72%e5%88%9b%e5%bb%ba-svc-%e7%bd%91%e7%bb%9c" class="heading-mark"></a>7.2、创建 svc 网络</h5><div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建一个 svc 网络</span>
</span></span><span class="line"><span class="cl">kubectl create svc clusterip nginx --tcp<span class="o">=</span>80:80
</span></span><span class="line"><span class="cl"><span class="c1"># 查看当前 svc 网络</span>
</span></span><span class="line"><span class="cl">kubectl get svc</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc9679d176a.png" alt="image-20220516144027369.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc9679d176a.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc9679d176a.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc9679d176a.png?size=large 2x" data-title="image-20220516144027369.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h2 id="4资源清单" class="heading-element">
  <a href="#4%e8%b5%84%e6%ba%90%e6%b8%85%e5%8d%95" class="heading-mark"></a>4、资源清单</h2><blockquote>
<p>在 k8s 中所有的内容都是资源，资源实例化之后，叫做对象</p>
<p>资源：</p>
<ul>
<li>命名空间级别
<ul>
<li>工作负载型资源：Pod、ReplicaSet、Deployment 等</li>
<li>服务发现及负载均衡型资源：Service、Ingress 等</li>
<li>配置与存储型资源：Volume、CSI 等</li>
<li>特殊类型的存储卷：ConfigMap、Secre 等</li>
</ul>
</li>
<li>集群级资源
<ul>
<li>Namespace、Node、ClusterRole、ClusterRoleBinding</li>
</ul>
</li>
<li>元数据类型资源
<ul>
<li>HPA、PodTemplate、LimitRange</li>
</ul>
</li>
</ul>
<p>在 k8s 中，一般使用 yaml 格式的文件来创建符合我们预期期望的对象，这样的 yaml 文件我们一般称为资源清单</p>
</blockquote>
<h3 id="格式" class="heading-element">
  <a href="#%e6%a0%bc%e5%bc%8f" class="heading-mark"></a>格式</h3><div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">group/apiversion</span><span class="w"> </span><span class="c"># 如果没有给定 group 名称，那么默认为 core，可以使用 kubectl apt-versions 获取当前 k8s 版本上所有的 apiVersion 版本信息（每个版本可能不同）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="c"># 资源类别</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadate</span><span class="p">:</span><span class="w"> </span><span class="c"># 资源元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="l">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="l">namespace</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="l">lables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="l">annotations</span><span class="w"> </span><span class="c"># 主要目的是方便用户阅读查找</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 期望的状态 （disired state）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="c"># 当前状态，本字段由 kubernetes 自身维护，用户不能定义</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="常用命令" class="heading-element">
  <a href="#%e5%b8%b8%e7%94%a8%e5%91%bd%e4%bb%a4" class="heading-mark"></a>常用命令</h3><p>必须记住的命令 <code>kubectl explain xxx.xxx</code>
必须记住的命令 <code>kubectl explain xxx.xxx</code>
必须记住的命令 <code>kubectl explain xxx.xxx</code></p>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查询</span>
</span></span><span class="line"><span class="cl"><span class="c1"># -n 指定命名空间，默认为 default</span>
</span></span><span class="line"><span class="cl">kuebctl get pod -o wide -l <span class="o">[</span>key/key<span class="o">=</span>values<span class="o">]</span> <span class="c1"># 获取 pod 列表</span>
</span></span><span class="line"><span class="cl">kubectl get pod podName -o json/yaml <span class="c1"># 获取 pod 详细信息</span>
</span></span><span class="line"><span class="cl">kubectl log podName <span class="c1"># 获取 pod 日志</span>
</span></span><span class="line"><span class="cl">kubectl describe pod podName <span class="c1"># 获取 pod 事件信息</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 操作</span>
</span></span><span class="line"><span class="cl">kubectl create -f filename <span class="c1"># 创建资源</span>
</span></span><span class="line"><span class="cl">kubectl <span class="nb">exec</span> -it podName -c containerName -- <span class="o">[</span>script<span class="o">]</span> <span class="c1"># 在某个容器内执行脚本</span>
</span></span><span class="line"><span class="cl">kubectl delete <span class="o">[</span>res<span class="o">]</span> <span class="o">[</span>--all <span class="p">|</span> name<span class="o">]</span> <span class="c1"># 删除资源</span>
</span></span><span class="line"><span class="cl">kubectl scale --replicas<span class="o">=[</span>num<span class="o">]</span> <span class="o">[</span>controllerKind<span class="o">]</span>/<span class="o">[</span>resName<span class="o">]</span> <span class="c1"># 修改某个控制器的副本数量</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="获取-apiversion-版本信息" class="heading-element">
  <a href="#%e8%8e%b7%e5%8f%96-apiversion-%e7%89%88%e6%9c%ac%e4%bf%a1%e6%81%af" class="heading-mark"></a>获取 apiversion 版本信息</h4><div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl api-versions
</span></span><span class="line"><span class="cl"><span class="c1"># output:</span>
</span></span><span class="line"><span class="cl">admissionregistration.k8s.io/v1
</span></span><span class="line"><span class="cl">apiextensions.k8s.io/v1
</span></span><span class="line"><span class="cl">apiregistration.k8s.io/v1
</span></span><span class="line"><span class="cl">apps/v1
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="字段配置格式" class="heading-element">
  <a href="#%e5%ad%97%e6%ae%b5%e9%85%8d%e7%bd%ae%e6%a0%bc%e5%bc%8f" class="heading-mark"></a>字段配置格式</h4><div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">apiVersion &lt;string&gt;        <span class="c1"># 表示字符串类型</span>
</span></span><span class="line"><span class="cl">metadata &lt;object&gt;          <span class="c1"># 表示需要嵌套多层字段</span>
</span></span><span class="line"><span class="cl">labels &lt;map<span class="o">[</span>string<span class="o">]</span>string&gt; <span class="c1"># 表示由 k:v 组成的映射</span>
</span></span><span class="line"><span class="cl">finalizers &lt;<span class="o">[]</span>string&gt;      <span class="c1"># 表示字符串列表</span>
</span></span><span class="line"><span class="cl">ownerReferences &lt;<span class="o">[]</span>object&gt; <span class="c1"># 表示对象列表</span>
</span></span><span class="line"><span class="cl">hostPID &lt;boolean&gt;          <span class="c1"># true | flase</span>
</span></span><span class="line"><span class="cl">priority &lt;integer&gt;         <span class="c1"># 整型</span>
</span></span><span class="line"><span class="cl">name &lt;string&gt; -required-   <span class="c1"># 如果类型后面接 required，表示为必填字段</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="通过定义清单文件创建-pod" class="heading-element">
  <a href="#%e9%80%9a%e8%bf%87%e5%ae%9a%e4%b9%89%e6%b8%85%e5%8d%95%e6%96%87%e4%bb%b6%e5%88%9b%e5%bb%ba-pod" class="heading-mark"></a>通过定义清单文件创建 Pod</h3><div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">lables</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">myPod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myPod-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myPod-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybos:1.34.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;/bin/sh&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;-c&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="s2">&#34;sleep 3600&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 使用 -o 选项加 yaml，可以将资源的配置以 yaml 的格式输出，也可以使用 json</span>
</span></span><span class="line"><span class="cl">kubectl get pod xxx.xxx.xxx -o yaml</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="5pod-生命周期" class="heading-element">
  <a href="#5pod-%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f" class="heading-mark"></a>5、Pod 生命周期</h2><h3 id="执行流程" class="heading-element">
  <a href="#%e6%89%a7%e8%a1%8c%e6%b5%81%e7%a8%8b" class="heading-mark"></a>执行流程</h3><p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967a1b824.png" alt="image-20220519113924249.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967a1b824.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967a1b824.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967a1b824.png?size=large 2x" data-title="image-20220519113924249.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<ol>
<li>Pause：在一个 Pod 启动前，会先启动一个 Pause 容器。它会初始化相应的网络栈，同时把自身的网络卷共享给 Pod 内的容器</li>
<li>初始化容器「initC」，可以有0到无限个
<ul>
<li>它是批处理类型的任务</li>
<li>它的运行是有序的，第一个不运行成功，第二个不会运行</li>
<li>如果执行失败，会直接重载整个 Pod，直到 Init 容器成功为止。然而，如果 Pod 对应的 restartPolicy 为 Never 则不会重启</li>
</ul>
</li>
<li>主容器「mainC」，至少存在一个
<ul>
<li>多个 mainC 并行启动</li>
<li>多个 mainC 共享同一个网络卷，绑定的端口不能重复</li>
<li>hook
<ul>
<li>启动前「和主进程同时运行，不一定在主进程运行前执行完成」</li>
<li>关闭前「可以保证在关闭前执行完成」</li>
</ul>
</li>
<li>探针「tcp｜http｜script」
<ul>
<li>可以进行就绪、存活探测探针：判断是否可以进行后续探针，新版本才存在</li>
<li>就绪探针：判断一个 mainC 是否已经准备好提供服务，可以定义探测间隔</li>
<li>存活探针：判断一个 mainC 是否存活，如无响应则重启容器</li>
</ul>
</li>
</ul>
</li>
</ol>
<h3 id="init-容器" class="heading-element">
  <a href="#init-%e5%ae%b9%e5%99%a8" class="heading-mark"></a>init 容器</h3><p>因为 Init 容器具有与应用容器分离的单独镜像，所以它们的启动相关代码具有如下优势：</p>
<ul>
<li>它们可以包含并运行实用工具，但是出于安全考虑，不建议在应用容器镜像中包含这些工具</li>
<li>应用程序镜像可以分离出创建和部署的角色，而没有必要联合它们构建一个单独的镜像</li>
<li>Init 容器使用 Linux Namespace，所以相对于应用容器来说具有不同的文件系统视图。因此，他们能够具有访问 Secret 的权限，而应用程序则不能</li>
<li>他们必须在应用容器启动之前运行完成，而应用容器是并行运行的，所以 Init 容器能够提供一种简单的阻塞或延迟应用容器启动的方法，直到满足啦一组先决条件</li>
<li>Init 容器具有应用容器的所有字段。除了 readinessProbe，因为 Init 容器无法定义不同于完成和就绪之外的其他状态，这会在验证过程中强制执行</li>
<li>在 Pod 中的每个 app 和 init 容器的名称必须唯一；与其他任何容器共享同一个名称，会在验证时抛出错误</li>
</ul>
<h3 id="简单实操" class="heading-element">
  <a href="#%e7%ae%80%e5%8d%95%e5%ae%9e%e6%93%8d" class="heading-mark"></a>简单实操</h3><div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># testpod.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">initContainers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">init-my-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;sh&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-c&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;until nslookup my-service; do echo waiting for my-service; sleep 2; done;&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">init-my-db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;sh&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-c&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;until nslookup my-db; do echo waiting for my-db; sleep 2; done;&#39;</span><span class="p">]</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># init-testpod.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">9376</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">9377</span></span></span></code></pre></td></tr></table>
</div>
</div><p>先创建 init 模板</p>
<div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl create -f init-pod.yaml</span></span></code></pre></td></tr></table>
</div>
</div><p>查看 Pod 状态</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl get po</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967a42ca7.png" alt="image-20220520113207122.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967a42ca7.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967a42ca7.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967a42ca7.png?size=large 2x" data-title="image-20220520113207122.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>查看初始化容器日志</p>
<div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl logs my-nginx-pod -c init-my-service</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967a81553.png" alt="image-20220520113313026.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967a81553.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967a81553.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967a81553.png?size=large 2x" data-title="image-20220520113313026.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>发现一直在解析域名，这时我们创建响应的 service</p>
<div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl create -f init-test-pod.yaml</span></span></code></pre></td></tr></table>
</div>
</div><p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967ad3879.png" alt="image-20220520114643785.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967ad3879.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967ad3879.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967ad3879.png?size=large 2x" data-title="image-20220520114643785.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>然后我们再去查看容器的状态，可能需要等待一定的时间</p>
<p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967aa9460.png" alt="image-20220520114607465.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967aa9460.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967aa9460.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967aa9460.png?size=large 2x" data-title="image-20220520114607465.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="探针" class="heading-element">
  <a href="#%e6%8e%a2%e9%92%88" class="heading-mark"></a>探针</h3><p>探针是由 kubelet 对容器执行的定期诊断，要执行诊断，kubelet 调用容器实现的 Handler。有三种类型的处理程序：</p>
<ul>
<li>ExecAction：在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功</li>
<li>TCPSocketAction：对指定端口上的容器 IP 地址进行 TCP 检查。如果端口打开，则诊断被任务时成功的</li>
<li>HTTPGetAction：对指定的端口和路径上的容器 IP 地址执行 HTTP Get 请求。如果响应的状态码大于等于 200 且小于 400，则诊断被认为是成功的</li>
</ul>
<p>每次探测都将获得以下三种结果：</p>
<ul>
<li>成功：容器通过诊断</li>
<li>失败：容器未通过诊断</li>
<li>未知：诊断失败，但不会采取任何行动</li>
</ul>
<h4 id="readinessprobe就绪探针" class="heading-element">
  <a href="#readinessprobe%e5%b0%b1%e7%bb%aa%e6%8e%a2%e9%92%88" class="heading-mark"></a><strong>readinessProbe「就绪探针」</strong></h4><p>指示容器是否准备好服务请求。如果就绪探测失败，端点控制器将从与 Pod 匹配的所有 Service 的端点中删除该 Pod 的 IP 地址。初始延迟前的就绪状态默认为 Failure。如果容器不提供就绪探针，则默认状态为 SUCCESS</p>
<div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># readinessProbe-httpget</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">reaadiness-httpget-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">myapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">readiness-httpget-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">imagePullPolice</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w"> </span><span class="c"># 配置就绪探针</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">httpGet</span><span class="p">:</span><span class="w"> </span><span class="c"># 探针类型，请求端口和 path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">readiness.html</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 开始探测延迟</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 探测间隔</span></span></span></code></pre></td></tr></table>
</div>
</div><p>创建该 Pod 后，会发现 Pod 处于运行状态，但是 READY 却是 <code>0/1</code>。这时我们查看容器日志，发现探针返回为 404，此时表示探针正常生效。</p>
<p>我们进入容器，在 nginx 的根目录下创建<code>readiness.html</code>文件，退出后发现容器已处于就绪状态。</p>
<h4 id="livenessprobe存活探针" class="heading-element">
  <a href="#livenessprobe%e5%ad%98%e6%b4%bb%e6%8e%a2%e9%92%88" class="heading-mark"></a><strong>livenessProbe「存活探针」</strong></h4><p>指示容器是否正在运行。如果存活探测失败，则 kubelet 会杀死容器，并且容器将根据重启策略来判断是否重新拉起。如果容器不提供存活探针，则默认状态为 SUCCESS</p>
<div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># livenessProbe-exec</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">liveness-exec-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">liveness-exec-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;touch /tmp/live; sleep 60; rm -rf /tmp/live; sleep 3600&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># 运行脚本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">exec</span><span class="p">:</span><span class="w"> </span><span class="c"># exec 类型探针</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;test&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-e&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;/tmp/live&#34;</span><span class="p">]</span><span class="w"> </span><span class="c"># 执行脚本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 开始探测延迟</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 探测间隔</span></span></span></code></pre></td></tr></table>
</div>
</div><p>创建该 Pod 后，在前 60 秒内正常运行，之后发现 Pod 被杀死并重新创建。</p>
<div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># livenessProbe-httpget</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">liveness-httpget-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">liveness-httpget-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">httpGet</span><span class="p">:</span><span class="w"> </span><span class="c"># 探针类型，请求端口和 path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">index.html</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 开始探测延迟</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 探测间隔</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 超时时间</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># livenessProbe-tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">liveness-tcp-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">liveness-tcp-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tcp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">tcpSocket</span><span class="p">:</span><span class="w"> </span><span class="c"># 探针类型，请求端口</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="c"># 开始探测延迟</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 超时时间</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="启动退出动作hook" class="heading-element">
  <a href="#%e5%90%af%e5%8a%a8%e9%80%80%e5%87%ba%e5%8a%a8%e4%bd%9chook" class="heading-mark"></a>启动、退出动作「hook」</h3><div class="highlight" id="id-15"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">lifecycle-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">lifecycle-demo-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w"> </span><span class="c"># 生命周期</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">postStart</span><span class="p">:</span><span class="w"> </span><span class="c"># 启动前</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;echo postStart &gt; /usr/share/message&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">preStart</span><span class="p">:</span><span class="w"> </span><span class="c"># 关闭前</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;echo preStart &gt; /usr/share/message&#34;</span><span class="p">]</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在进入容器后，就可以看到<code>/usr/share/message</code>存在，并且内容是我们自定义的<code>postStart</code>。我们进去容器死循环打印文件</p>
<div class="highlight" id="id-16"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="k">while</span> true<span class="p">;</span> <span class="k">do</span> cat /usr/share/message<span class="p">;</span> <span class="k">done</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在外部关闭容器后，发现打印变成了<code>preStart</code></p>
<h2 id="6控制器详解" class="heading-element">
  <a href="#6%e6%8e%a7%e5%88%b6%e5%99%a8%e8%af%a6%e8%a7%a3" class="heading-mark"></a>6、控制器详解</h2><h3 id="rc-控制器" class="heading-element">
  <a href="#rc-%e6%8e%a7%e5%88%b6%e5%99%a8" class="heading-mark"></a>RC 控制器</h3><div class="highlight" id="id-17"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># file: rc.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicationController</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 副本数量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 标签选择器，寻找 app=nginx 的 Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># 创建 Pod 模板</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在创建上述文件后，我们执行</p>
<div class="highlight" id="id-18"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl create -f rc.yaml</span></span></code></pre></td></tr></table>
</div>
</div><p>然后我们查看对应 Pod：</p>
<p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967b0df40.png" alt="image-20220524112307900.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967b0df40.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967b0df40.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967b0df40.png?size=large 2x" data-title="image-20220524112307900.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>这也就是 RC 控制器的功能，我们可以尝试删除其中一个 Pod 会发现又被重新创建</p>
<p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967b3ca17.png" alt="image-20220524112425852.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967b3ca17.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967b3ca17.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967b3ca17.png?size=large 2x" data-title="image-20220524112425852.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="rs-控制器" class="heading-element">
  <a href="#rs-%e6%8e%a7%e5%88%b6%e5%99%a8" class="heading-mark"></a>RS 控制器</h3><div class="highlight" id="id-19"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">frontend</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 副本数量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 标签选择器，寻找 app=nginx 的 Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c"># matchExpressions: 可选</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># 创建 Pod 模板</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><p>RS 控制器相比 RC 控制器，只是多了一种标签选择器，我们可以通过下面的命令查看对应的文档：</p>
<div class="highlight" id="id-20"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl explain rs.spec.selector</span></span></code></pre></td></tr></table>
</div>
</div><p>可以看到除了和 RC 控制器功能一致的<code>matchLabels</code>，还多了一种<code>matchExpressions</code>可选择。</p>
<p><code>matchExpressions</code>目前能支持的操作包括：</p>
<ul>
<li>In：label 的值在某个列表中</li>
<li>NotIn：label 的值不在某一个列表中</li>
<li>Exists：某个 label 存在</li>
<li>DoesNotExist：某个 label 不存在</li>
</ul>
<h4 id="示例" class="heading-element">
  <a href="#%e7%a4%ba%e4%be%8b" class="heading-mark"></a>示例</h4><div class="highlight" id="id-21"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># selector exists demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rs-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># 这里</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">Exists</span><span class="w"> </span><span class="c"># label 中 key 为 app 存在即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-22"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># selector In demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">rs-demo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># 这里</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w"> </span><span class="c"># label 中 key 对应的 value 在枚举的 values 中即可</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="l">nginx1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="deployment-控制器" class="heading-element">
  <a href="#deployment-%e6%8e%a7%e5%88%b6%e5%99%a8" class="heading-mark"></a>Deployment 控制器</h3><blockquote>
<p>命令的定义方式</p>
<ul>
<li>命令式定义 kubectl create -f xxxxx</li>
<li>声明式定义 kubectl apply -f xxxxx</li>
</ul>
<p>区别：声明式命令可以重复使用，系统会自动判断当前操作是修改还是创建</p>
<p>推荐直接使用 apply，在遇到命令式资源时会自动降级成命令式</p>
</blockquote>
<p>Deployment 为 Pod 和 ReplicaSet 提供来一个声明式定义方法，用来代替之前的 ReplicationController 来方便管理应用。典型的应用场景包括：</p>
<ul>
<li>定义 Deployment 来创建 Pod 和 ReplicaSet</li>
<li>滚动升级和回滚应用</li>
<li>扩容和缩容</li>
<li>暂停和继续 Deployment</li>
</ul>
<h4 id="1部署一个简单的-nginx-应用" class="heading-element">
  <a href="#1%e9%83%a8%e7%bd%b2%e4%b8%80%e4%b8%aa%e7%ae%80%e5%8d%95%e7%9a%84-nginx-%e5%ba%94%e7%94%a8" class="heading-mark"></a>1、部署一个简单的 Nginx 应用</h4><div class="highlight" id="id-23"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-24"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl apply -f https://kubernetes.io/docs/user-guide/nginx-deployment.yaml --record
</span></span><span class="line"><span class="cl"><span class="c1"># --record 可以记录当前命令到 deployment 到历史记录中</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2扩容" class="heading-element">
  <a href="#2%e6%89%a9%e5%ae%b9" class="heading-mark"></a>2、扩容</h4><div class="highlight" id="id-25"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 修改副本数量为 10，不会影响 deployment 已经创建的 rs</span>
</span></span><span class="line"><span class="cl">kubectl scale deployment nginx-deployment --replicas <span class="m">10</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>如果集群支持 horizontal pod autoscaling 的话，还可以为 Deployment 设置自动扩展</strong></p>
<div class="highlight" id="id-26"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl autoscale deployment nginx-deployment --min<span class="o">=</span><span class="m">10</span> --max<span class="o">=</span><span class="m">15</span> --cpu-percent<span class="o">=</span><span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3更新镜像" class="heading-element">
  <a href="#3%e6%9b%b4%e6%96%b0%e9%95%9c%e5%83%8f" class="heading-mark"></a>3、更新镜像</h4><div class="highlight" id="id-27"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl <span class="nb">set</span> image deployment/nginx-deployment <span class="nv">nginx</span><span class="o">=</span>nginx:1.9.1</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="4回滚" class="heading-element">
  <a href="#4%e5%9b%9e%e6%bb%9a" class="heading-mark"></a>4、回滚</h4><div class="highlight" id="id-28"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl rollout undo deployment/nginx-deployment</span></span></code></pre></td></tr></table>
</div>
</div><p>假如当前有4个版本 v1、v2、v3、v4，目前的版本为 v4，使用上述命令回滚之后回滚到 v3 版本，再次使用上述命令，此时回重新回滚到 v4 版本，因为当前的上一个版本为 v4，如果想指定版本可以使用下述命令：</p>
<div class="highlight" id="id-29"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看历史版本记录，如果使用了 --replicas 会显示当时的命令</span>
</span></span><span class="line"><span class="cl">kubectl rollout <span class="nb">history</span> deployment/nginx-deployment
</span></span><span class="line"><span class="cl"><span class="c1"># 回滚到指定版本</span>
</span></span><span class="line"><span class="cl">kubectl rollout undo deployment/nginx-deployment --to-revision<span class="o">=</span><span class="m">2</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 暂停 deployment 的更新</span>
</span></span><span class="line"><span class="cl">kubectl rollout pause deployment/nginx-deployment
</span></span><span class="line"><span class="cl"><span class="c1"># 可以使用 kubectl rollout status 查看回滚是否完成，同时命令返回 code 为 0，可以使用脚本来判断</span>
</span></span><span class="line"><span class="cl">kubectl rollout status depoyment/nginx-deployment</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>限制版本数量</strong></p>
<p>可以设置<code>.spec.revisionHistoryLimit</code>来设置保留的版本数量，这个数量也就是 deployment 管理的历史 rs 数量</p>
<p><strong>多个 rollout 并行</strong></p>
<p>假设当前有 10 个 Pod 正在从 v1 版本升级至 v2 版本，此时 v1 : 5、v2 : 5。</p>
<p>这时我们再升级至 v3 版本，此时升级的 5 个 v2 版本的 Pod 会直接被杀死，然后直接创建 v3 版本的 Pod。</p>
<p><strong>常用回滚策略</strong></p>
<p>一般在企业中不会使用 revision 这种回滚方式，而是会复制最近版本的配置文件，修改名称后直接进行 apply 操作，比如<code>nginx-deployment-2022-06-06 12:00:00.yaml</code>。这样的话出现问题可以直接 apply 至上一个配置文件即可。</p>
<h4 id="5更新策略" class="heading-element">
  <a href="#5%e6%9b%b4%e6%96%b0%e7%ad%96%e7%95%a5" class="heading-mark"></a>5、更新策略</h4><p>Deployment 可以保证在升级时只有一定数量的 Pod 是 down 的。默认它会确保至少有比期望的副本数量少一个为 up 状态，也就是最多一个不可用</p>
<p>同时也可以确保只创建出超过期望一定数量的 Pod，默认会比期望的副本数量多一个是 up 状态</p>
<p>未来的 kuberentes 版本中，将从 1-1 变成 25%-25%</p>
<p>当然，也支持自定义更新策略</p>
<blockquote>
<p>kubectl explain deploy.spec.strategy.type</p>
<ul>
<li>Recreate：重新创建</li>
<li>rollingUpdate：滚动更新（推荐）
<ul>
<li>maxSurge：指定超出副本数有几个，两种方式：1、指定数量 2、百分比</li>
<li>maxUnavailable：指定副本数量最多有几个不可用</li>
</ul>
</li>
</ul>
</blockquote>
<div class="highlight" id="id-30"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查询当前更新策略</span>
</span></span><span class="line"><span class="cl">kubectl describe deployments <span class="o">{</span>控制器名称<span class="o">}</span> <span class="c1"># 找到 RollingUpdateStrategy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 修改当前更新策略</span>
</span></span><span class="line"><span class="cl">kubectl edit deployment <span class="o">{</span>控制器名称<span class="o">}</span> <span class="c1"># 找到 rollingUpdate</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 或者使用 patch 打补丁</span>
</span></span><span class="line"><span class="cl">kubectl patch deployment nginx-deployment -p <span class="s1">&#39;{&#34;spec&#34;: {&#34;strategy&#34;: {&#34;rollingUpdate&#34;: {&#34;maxSurge&#34;:1, &#34;maxUnavailable&#34;: 0}}}}&#39;</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="6金丝雀部署" class="heading-element">
  <a href="#6%e9%87%91%e4%b8%9d%e9%9b%80%e9%83%a8%e7%bd%b2" class="heading-mark"></a>6、金丝雀部署</h4><div class="highlight" id="id-31"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 需要设置当前更新策略为 maxSurge:1 maxUnavailable:0</span>
</span></span><span class="line"><span class="cl">kubectl patch deployment nginx-deployment -p <span class="s1">&#39;{&#34;spec&#34;: {&#34;strategy&#34;: {&#34;rollingUpdate&#34;: {&#34;maxSurge&#34;:1, &#34;maxUnavailable&#34;: 0}}}}&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 开始更新后直接暂停，此时只会新建一个新版本的 Pod，旧版本的 Pod 不会进行删除</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 此时 svc 网络会将流量负载均衡至当前全部 Pod，就可以测试新版本了</span>
</span></span><span class="line"><span class="cl">kubectl <span class="nb">set</span> image deployment nginx-deployment <span class="nv">nginx</span><span class="o">=</span>nginx:1.9.1 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="o">&amp;&amp;</span> kubectl rollout pause deployment nginx-deployment
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 等待测试结束后，继续更新</span>
</span></span><span class="line"><span class="cl">kubectl rollout resume deployment nginx-deployment</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="daemonset-1" class="heading-element">
  <a href="#daemonset-1" class="heading-mark"></a>DaemonSet</h3><p>DaemonSet 确保全部（或者一些）Node 上运行一个 Pod 的副本。当有 Node 假如集群时，也会为他们新增一个 Pod。当有 Node 从集群移除时，这些 Pod 也会被回收。删除 DaemonSet 将会删除它创建的所有 Pod</p>
<p>使用 DaemonSet 的一些典型用法：</p>
<ul>
<li>运行集群存储 daemon，例如在每个 Node 上运行<code>glusterd</code>、<code>ceph</code></li>
<li>在每个 Node 上运行日志收集 daemon，例如<code>fluentd</code>、<code>logstash</code></li>
<li>在每个 Node 上运行监控 darmon，例如<code>Promentheus Node Exproter</code>、<code>collectd</code>、<code>Datadog代理</code>、<code>New Relic 代理</code>或者<code>Ganglia gmond</code></li>
</ul>
<div class="highlight" id="id-32"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daemonset-example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">daemonset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daemonset-example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daemonset-example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">daemonset-example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="job" class="heading-element">
  <a href="#job" class="heading-mark"></a>Job</h3><p>Job 负责批处理任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束</p>
<p>特殊说明</p>
<ul>
<li><code>.spec.template</code>格式同 Pod</li>
<li>RestartPolicy 仅支持 Never 或者 OnFailure</li>
<li>当个 Pod 时，默认 Pod 运行成功后 Job 即结束</li>
<li><code>.spec.completions</code>标志 Job 结束需要成功运行的 Pod 个数，默认为 1</li>
<li><code>.spec.parallelism</code>标志并行运行的 Pod 个数，默认为 1</li>
<li><code>spec.activeDeadlineSecods</code>标志失败 Pod 的重试最大时间，超过这个时间不会继续重试</li>
</ul>
<div class="highlight" id="id-33"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;echo&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;this is a job container&#39;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="cronjob" class="heading-element">
  <a href="#cronjob" class="heading-mark"></a>CronJob</h3><p>CronJob 基于时间管理的 Job，即：</p>
<ul>
<li>在给定的时间点只运行一次</li>
<li>周期性的在给定时间点运行</li>
</ul>
<p>使用条件：当前使用 k8s 集群，版本 &gt;= 1.8</p>
<p>典型用法：</p>
<ul>
<li>在给定的时间点调度 Job 运行</li>
<li>创建周期性运行的 Job，例如：数据库备份、发送邮件</li>
</ul>
<p>Spec</p>
<ul>
<li>
<p><code>.spec.schedule</code>：调度，必须字段，指定任务运行周期，格式同 Cron</p>
</li>
<li>
<p><code>.spec.jobTemplate</code>：Job 模板，必须字段，指定需要运行的任务，格式同 Job</p>
</li>
<li>
<p><code>.spec.startingDeadlineSeconds</code>：启动 Job 的时间（秒），选填，超出该时间未启动认定为失败，默认没有期限</p>
</li>
<li>
<p><code>.spce.concurrencyPolicy</code>：并发策略，选填，指定 Job 的并发执行，只允许以下策略：</p>
<ul>
<li>Allow （默认）：允许并发运行</li>
<li>Forbid： 禁止并发运行，如果前一个还没有完成，则跳过</li>
<li>Replace：取消当前正在运行的 Job，用一个新的替换</li>
</ul>
<p>以上策略只能应用于同一个 CronJob 创建的 Job，如果存在多个 CronJob，它们之间总是互不干涉的</p>
</li>
</ul>
<h2 id="7service" class="heading-element">
  <a href="#7service" class="heading-mark"></a>7、Service</h2><blockquote>
<p>Kubernetes Service 定义了这样一种抽象：</p>
<p>一个 Pod 的逻辑分组，一种可以访问它们的策略，通常称为 微服务</p>
<p>这一组 Pod 能够被 Service 访问到，通常是通过 Label Selector</p>
</blockquote>
<h3 id="核心迭代" class="heading-element">
  <a href="#%e6%a0%b8%e5%bf%83%e8%bf%ad%e4%bb%a3" class="heading-mark"></a>核心迭代</h3><p>在 Kubernetes 集群中，每一个 Node 运行一个 <code>kube-proxy</code>进程。<code>kube-proxy</code> 负责为 <code>Service</code>实现一种 VIP（虚拟IP）的形式，而不是<code>ExternalName</code>的形式。在 Kubernetes v1.0 版本，代理完全在 userspace。在 Kubernetes v1.1 版本，增加了 iptables 代理，但并不是默认的运行模式。从 Kubernetes v1.2 起，默认就是 iptables 代理。在 Kubernetes v1.8.0-beta.0 中，添加了 ipvs 代理。在 Kubernetes v1.14 版本开始默认使用 ipvs 代理。</p>
<p>在 Kubernetes v1.0 版本，Service 是 4层（TCP/UDP over IP）概念。在 Kubernetes v1.1 版本，新增了 Ingress API（beta 版），用来表示 7层（HTTP）服务。</p>
<h4 id="1userspace-代理模式" class="heading-element">
  <a href="#1userspace-%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" class="heading-mark"></a>1、userspace 代理模式</h4><p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967b81671.png" alt="image-20220623162309337.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967b81671.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967b81671.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967b81671.png?size=large 2x" data-title="image-20220623162309337.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h4 id="2iptables-代理模式" class="heading-element">
  <a href="#2iptables-%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" class="heading-mark"></a>2、iptables 代理模式</h4><p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967bcda8f.png" alt="image-20220623162348313.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967bcda8f.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967bcda8f.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967bcda8f.png?size=large 2x" data-title="image-20220623162348313.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h4 id="3ipvs-代理模式" class="heading-element">
  <a href="#3ipvs-%e4%bb%a3%e7%90%86%e6%a8%a1%e5%bc%8f" class="heading-mark"></a>3、ipvs 代理模式</h4><p>注意：ipvs 模式假定运行 kube-proxy 之前在节点上都已经安装了 IPVS 内核模块。当 kube-proxy以 ipvs 代理模式启动时，kube-proxy 将验证节点是否安装 IPVS 模块，如果未安装，则回退到 iptables 代理模式</p>
<p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/17/62fc967c30fc1.png" alt="image-20220623162509357.png" srcset="https://lsky.ronin-zc.com/i/2022/08/17/62fc967c30fc1.png?size=small, https://lsky.ronin-zc.com/i/2022/08/17/62fc967c30fc1.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/17/62fc967c30fc1.png?size=large 2x" data-title="image-20220623162509357.png" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="限制" class="heading-element">
  <a href="#%e9%99%90%e5%88%b6" class="heading-mark"></a>限制</h3><p>Service 能够提供负载均衡的能力，但是在使用上有以下限制：</p>
<ul>
<li>只提供 4 层负载均衡能力，没有 7 层的功能，但有时我们需要更多的匹配规则来转发请求，这点 4 层负载均衡是不支持的</li>
</ul>
<h3 id="类型" class="heading-element">
  <a href="#%e7%b1%bb%e5%9e%8b" class="heading-mark"></a>类型</h3><ul>
<li>ClusterIP：默认类型，自动分配一个仅 Cluster 内部可以访问的虚拟 IP</li>
<li>NodePort：在 Cluster Ip 基础上为 Service 在每台机器上绑定一个端口，这样就可以通过 <nodeIP>:<nodePort> 来访问服务</li>
<li>LoadBalancer：在 NodePort 的基础上，结束 cloud provider 创建一个外部负载均衡器，并将请求转发到 <nodeIP>:<nodePort></li>
<li>ExternalName：把集群外部的服务引入到集群内部来，在集群内部直接使用。没有任何类型代理被创建，这自由 Kubernetes 1.7 或更高版本的 kube-dns 才支持</li>
</ul>
<h4 id="1clusterip" class="heading-element">
  <a href="#1clusterip" class="heading-mark"></a>1、ClusterIP</h4><div class="highlight" id="id-34"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">myapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">relese</span><span class="p">:</span><span class="w"> </span><span class="l">stable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Headless Service</strong></p>
<p>有时不需要或不想要负载均衡，以及单独的 Service IP。 遇到这种情况，可以通过指定 Cluster IP（<code>spec.clusterIP</code>）的值为 <code>&quot;None&quot;</code> 来创建 <code>Headless</code> Service。</p>
<p>你可以使用一个无头 Service 与其他服务发现机制进行接口，而不必与 Kubernetes 的实现捆绑在一起。</p>
<p>对于无头 <code>Services</code> 并不会分配 Cluster IP，kube-proxy 不会处理它们， 而且平台也不会为它们进行负载均衡和路由。 DNS 如何实现自动配置，依赖于 Service 是否定义了选择算符。</p>
<div class="highlight" id="id-35"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp-headless</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w">  </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">myapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;None&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="2nodeport" class="heading-element">
  <a href="#2nodeport" class="heading-mark"></a>2、NodePort</h4><div class="highlight" id="id-36"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp-nodeport</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">myapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">relese</span><span class="p">:</span><span class="w"> </span><span class="l">stable</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">30000</span><span class="w"> </span><span class="c"># 可指定</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3loadbalancer" class="heading-element">
  <a href="#3loadbalancer" class="heading-mark"></a>3、LoadBalancer</h4><p>loadBalacer 和 nodePort 其实是同一种方式，区别在于 loadBalancer 比 nodePort 多了一步，就是可以调用 cloud provider 去创建 LB 来向节点导流</p>
<p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/23/630468c085d19.png" alt="image-20220823134223567" srcset="https://lsky.ronin-zc.com/i/2022/08/23/630468c085d19.png?size=small, https://lsky.ronin-zc.com/i/2022/08/23/630468c085d19.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/23/630468c085d19.png?size=large 2x" data-title="image-20220823134223567" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h4 id="4externalname" class="heading-element">
  <a href="#4externalname" class="heading-mark"></a>4、ExternalName</h4><p>可以将服务映射到 ExternalName 字段的内容（例如：myapp.otherNS）。ExternalName Service 是 Service 的特例，它没有 selector，也没有定义任何的端口和 Endpoint。相反的、对于运行在集群外部的服务，它通过返回外部服务的别名这种方式来提供服务</p>
<div class="highlight" id="id-37"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ExternalName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">externalName</span><span class="p">:</span><span class="w"> </span><span class="l">myapp.otherNS</span></span></span></code></pre></td></tr></table>
</div>
</div><p>但查询主机<code>my-service.default.svc.cluster.local</code>（SVC NAME.NAMESPACE.svc.cluster.local）时，集群的 coreDNS 服务将返回一个值 <code>my.database.example.com</code> 的 CANEM 记录。访问这个服务的工作方式和其他的相同，唯一不同的事重定向发生在 DNS 层，而且不会进行代理和转发</p>
<h2 id="8ingress" class="heading-element">
  <a href="#8ingress" class="heading-mark"></a>8、Ingress</h2><p>Ingress 的功能与 service 大致相似，不同的是 ingerss 提供了7层的代理，而 service 只提供了 4 层代理，如果希望实现 https 的访问则可以使用 Ingress</p>
<h3 id="实现原理" class="heading-element">
  <a href="#%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86" class="heading-mark"></a>实现原理</h3><p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/23/63048fc767815.png" alt="image-20220823162854855" srcset="https://lsky.ronin-zc.com/i/2022/08/23/63048fc767815.png?size=small, https://lsky.ronin-zc.com/i/2022/08/23/63048fc767815.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/23/63048fc767815.png?size=large 2x" data-title="image-20220823162854855" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<p>在 k8s 环境下创建一个 nginx pod，在内编写配置文件去反向代理 svc，同时提供 https 服务。其中的 nginx 在修改配置文件的状态下可能会造成服务的不稳定，所以 ingress 的 nginx 版本是不同的，具体逻辑见下图：</p>
<p><img loading="lazy" src="https://lsky.ronin-zc.com/i/2022/08/23/630478781b03f.png" alt="image-20220823144927462" srcset="https://lsky.ronin-zc.com/i/2022/08/23/630478781b03f.png?size=small, https://lsky.ronin-zc.com/i/2022/08/23/630478781b03f.png?size=medium 1.5x, https://lsky.ronin-zc.com/i/2022/08/23/630478781b03f.png?size=large 2x" data-title="image-20220823144927462" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/></p>
<h3 id="示例-1" class="heading-element">
  <a href="#%e7%a4%ba%e4%be%8b-1" class="heading-mark"></a>示例</h3><h4 id="http代理" class="heading-element">
  <a href="#http%e4%bb%a3%e7%90%86" class="heading-mark"></a>http代理</h4><div class="highlight" id="id-38"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myapp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">myapp:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">test.localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">app-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><p>可以发现 Ingress 依赖与 svc，避免依赖动态的服务副本数量频繁重启 Ingress</p>
<h4 id="https代理" class="heading-element">
  <a href="#https%e4%bb%a3%e7%90%86" class="heading-mark"></a>https代理</h4><p>创建 https 证书，以及创建 secret 对象进行存储</p>
<div class="highlight" id="id-39"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建证书</span>
</span></span><span class="line"><span class="cl">openssl req -x509 -sha256 -nodes -days <span class="m">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="s2">&#34;/CN=nginxsvc /O=nginxsvc&#34;</span>
</span></span><span class="line"><span class="cl">kubectl create secret tls tls-secret --key tls.key --cert tls.crt</span></span></code></pre></td></tr></table>
</div>
</div><p>配置文件</p>
<div class="highlight" id="id-40"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">app-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">test.localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">tls-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">test.localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">app-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="basicauth" class="heading-element">
  <a href="#basicauth" class="heading-mark"></a>BasicAuth</h4><p>创建密钥对</p>
<div class="highlight" id="id-41"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">yum -y install httpd-tools
</span></span><span class="line"><span class="cl">htpasswd -c auth foo
</span></span><span class="line"><span class="cl">kubectl create secret generic basic-auth --form-file<span class="o">=</span>auth</span></span></code></pre></td></tr></table>
</div>
</div><p>配置文件</p>
<div class="highlight" id="id-42"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">ingress-with-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">anntations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-type</span><span class="p">:</span><span class="w"> </span><span class="l">basic</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-secret</span><span class="p">:</span><span class="w"> </span><span class="l">basic-auth</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/auth-realm</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;Authentication Required - foo&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">test.localhost</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">app-svc</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w"> </span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="nginx-进行重写" class="heading-element">
  <a href="#nginx-%e8%bf%9b%e8%a1%8c%e9%87%8d%e5%86%99" class="heading-mark"></a>Nginx 进行重写</h4><table>
<thead>
<tr>
<th>名称</th>
<th>描述</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>nginx.ingress.kubernetes.io/rewrite-target</td>
<td>必须重定向流量的目标 URL</td>
<td>字符串</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io/ssl-redirect</td>
<td>指示位置部分是否仅可访问SSL（当 Ingress 包含证书时默认为 true）</td>
<td>布尔</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io/force-ssl-redirect</td>
<td>即使 Ingress 未启用 TLS，也强制重定向到 HTTPS</td>
<td>布尔</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io/app-root</td>
<td>定义 Controller 必须重定向到应用程序根，如果它在 &lsquo;/&rsquo; 上下文中</td>
<td>字符串</td>
</tr>
<tr>
<td>nginx.ingress.kubernetes.io/use-regex</td>
<td>指示 Ingress 上定义当路径是否使用正则表达式</td>
<td>布尔</td>
</tr>
</tbody>
</table>
<h2 id="9存储" class="heading-element">
  <a href="#9%e5%ad%98%e5%82%a8" class="heading-mark"></a>9、存储</h2><blockquote>
<p>K8S 集群中存储常用的有以下 4 种</p>
<ol>
<li>ConfigMap: 一般用于存储配置信息</li>
<li>Secret: 存储一些安全类型的内容，例如存储密钥</li>
<li>Volume: 卷，可以保障 Pod 级别的文件存储</li>
<li>Persistent Volume: 持久卷</li>
</ol>
</blockquote>
<h3 id="configmap" class="heading-element">
  <a href="#configmap" class="heading-mark"></a>ConfigMap</h3><h4 id="描述" class="heading-element">
  <a href="#%e6%8f%8f%e8%bf%b0" class="heading-mark"></a>描述</h4><p>ConfigMap 功能在 Kubernetes 1.2 版本中引入，许多应用程序会从配置文件、命令行参数或环境变量中读取配置信息。ConfigMap 可以被用来保存单个属性，也可以用来保存整个配置文件或者 JSON 二进制等对象</p>
<h4 id="创建" class="heading-element">
  <a href="#%e5%88%9b%e5%bb%ba" class="heading-mark"></a>创建</h4><p><strong>使用目录创建</strong></p>
<div class="highlight" id="id-43"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ls /root/game
</span></span><span class="line"><span class="cl"><span class="c1"># game.file</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ui.file</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat /root/game/game.file
</span></span><span class="line"><span class="cl"><span class="c1"># version=1.17</span>
</span></span><span class="line"><span class="cl"><span class="c1"># name=dave</span>
</span></span><span class="line"><span class="cl"><span class="c1"># age=18</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">cat /root/game/ui.file
</span></span><span class="line"><span class="cl"><span class="c1"># level=2</span>
</span></span><span class="line"><span class="cl"><span class="c1"># color=yellow</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl create configmap game-config --from-file<span class="o">=</span>/root/game</span></span></code></pre></td></tr></table>
</div>
</div><p><code>-from-file</code>指定在目录下当所有文件都会被用在 ConfigMap 里面创建一个键值对，键的名称就是文件名，值就是文件的内容</p>
<p><strong>使用文件创建</strong></p>
<p>只要指定为一个文件就可以从单文件中创建 ConfigMap</p>
<div class="highlight" id="id-44"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl create configmap game-config-2 --from-file<span class="o">=</span>/root/game/game.file</span></span></code></pre></td></tr></table>
</div>
</div><p><code>--form-file</code>这个参数可以使用多次、可以使用两次分别指定三个实例中的那两个配置文件，效果和指定整个目录是一样的</p>
<p><strong>使用字面值创建</strong></p>
<p>使用文字创建，利用<code>-from-literal</code>参数传递配置信息，该参数可以使用多次，格式如下</p>
<div class="highlight" id="id-45"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl create configmap literal-config --from-literal<span class="o">=</span><span class="nv">name</span><span class="o">=</span>dave --from-literal<span class="o">=</span><span class="nv">password</span><span class="o">=</span>pass
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">kubectl get configmap literal-config -o yaml</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="使用" class="heading-element">
  <a href="#%e4%bd%bf%e7%94%a8" class="heading-mark"></a>使用</h4><h5 id="使用-configmap-来代替环境变量" class="heading-element">
  <a href="#%e4%bd%bf%e7%94%a8-configmap-%e6%9d%a5%e4%bb%a3%e6%9b%bf%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f" class="heading-mark"></a>使用 ConfigMap 来代替环境变量</h5><p>创建两个 ConfigMap</p>
<div class="highlight" id="id-46"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">literal-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">dave</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">pass</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight" id="id-47"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">env-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">log_level</span><span class="p">:</span><span class="w"> </span><span class="l">INFO</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在 Pod 中使用 ConfigMap</p>
<div class="highlight" id="id-48"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cm-env-test-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">myapp:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;env&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 单个指定</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">USERNAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">literal-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PASSWORD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">valueForm</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">literal-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">password</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">envFrom</span><span class="p">:</span><span class="w"> </span><span class="c"># 批量注入</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">configMapRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">env-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="使用-configmap-设置命令行参数" class="heading-element">
  <a href="#%e4%bd%bf%e7%94%a8-configmap-%e8%ae%be%e7%bd%ae%e5%91%bd%e4%bb%a4%e8%a1%8c%e5%8f%82%e6%95%b0" class="heading-mark"></a>使用 ConfigMap 设置命令行参数</h5><div class="highlight" id="id-49"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cm-env-test-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">myapp:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;/bin/sh&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="w"> </span><span class="s2">&#34;echo $(USERNAME) $(PASSWORD)&#34;</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="c"># 单个指定</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">USERNAME</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">literal-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PASSWORD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">valueForm</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">literal-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">password</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="通过数据卷插件使用-configmap" class="heading-element">
  <a href="#%e9%80%9a%e8%bf%87%e6%95%b0%e6%8d%ae%e5%8d%b7%e6%8f%92%e4%bb%b6%e4%bd%bf%e7%94%a8-configmap" class="heading-mark"></a>通过数据卷插件使用 ConfigMap</h5><p>在数据卷里面使用这个 ConfigMap，有不同的选项、最基本的就是将文件填入数据卷，在这个文件中，键就是文件名称，值就是文件内容</p>
<div class="highlight" id="id-50"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cm-volume-test-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">myapp:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">       </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">literal-config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span></span></span></code></pre></td></tr></table>
</div>
</div><h5 id="热更新" class="heading-element">
  <a href="#%e7%83%ad%e6%9b%b4%e6%96%b0" class="heading-mark"></a>热更新</h5><p>在通过数据卷插件的形式使用 ConfigMap 时，可以达到<strong>热更新</strong>的目的，修改 ConfigMap 之后，在 Pod 中的对应文件内容也将修改成对应修改后的内容</p>
<p>创建初始 ConfigMap &amp; Pod</p>
<div class="highlight" id="id-51"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 初始内容</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">log-cofnig</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">log_level</span><span class="p">:</span><span class="w"> </span><span class="l">INFO</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">hot-update</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">myapp:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/etc/config</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">config-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">log-config</span></span></span></code></pre></td></tr></table>
</div>
</div><p>查看内容</p>
<div class="highlight" id="id-52"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> pod-xxx cat /etc/config/log_level
</span></span><span class="line"><span class="cl"><span class="c1"># INFO</span></span></span></code></pre></td></tr></table>
</div>
</div><p>修改 ConfigMap</p>
<div class="highlight" id="id-53"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl edit cm log-config
</span></span><span class="line"><span class="cl"><span class="c1"># log_level=ERROR</span></span></span></code></pre></td></tr></table>
</div>
</div><p>再次查看内容，需要一定时间</p>
<div class="highlight" id="id-54"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> pod-xxx cat /etc/config/log_level
</span></span><span class="line"><span class="cl"><span class="c1"># ERROR</span></span></span></code></pre></td></tr></table>
</div>
</div><p>**注意：**如果 configMap 以 ENV 的方式挂载，修改并不会实现热更新</p>
<h5 id="滚动更新pod" class="heading-element">
  <a href="#%e6%bb%9a%e5%8a%a8%e6%9b%b4%e6%96%b0pod" class="heading-mark"></a>滚动更新Pod</h5><p>在更新 ConfigMap 之后并不会触发 Pod 的滚动更新，可以通过修改 Pod annotations 的方式来强制出发滚动更新</p>
<div class="highlight" id="id-55"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl patch deploy my-nginx --patch <span class="s1">&#39;{&#34;spec&#34;: {&#34;template&#34;: {&#34;metadata&#34;: {&#34;anntations&#34;: {&#34;version/config&#34;: &#34;20190411&#34;}}}}}&#39;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个例子里我们在<code>.spec.template.metadata.annotations</code>中添加<code>version/config</code>，每次通过修改<code>version/config</code>来触发滚动更新</p>
<h3 id="secret" class="heading-element">
  <a href="#secret" class="heading-mark"></a>Secret</h3><p>解决了密码、token、密钥等敏感数据等配置问题，而不需要把这些敏感数据暴露到镜像或者 Pod Spec 中。Secret 可以以 Volume 或者环境变量方式使用</p>
<p>Secret有三种类型：</p>
<ul>
<li><strong>Service Account</strong>：用来访问 Kubernetes API，由 Kubernetes 自动创建，并且会自动挂载到 Pod 的 <code>/run/secrets/kubernetes.io/serviceaccount</code>目录中</li>
<li><strong>Opaque</strong>：base64 编码格式的 Secret，用来存储密码、密钥等</li>
<li><strong>kubernetes.io/dockerconfigjson</strong>：用来存放私有 docker 仓库等认证信息</li>
</ul>
<h4 id="service-account" class="heading-element">
  <a href="#service-account" class="heading-mark"></a>Service Account</h4><p>用来访问 Kubernetes API，由 Kubernetes 自动创建，并且会自动挂载到 Pod 的 <code>/run/secrets/kubernetes.io/serviceaccount</code>目录中</p>
<div class="highlight" id="id-56"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">kubectl <span class="nb">exec</span> pod-xxx -- ls /run/secrets/kubernetes.io/serviceaccount
</span></span><span class="line"><span class="cl"><span class="c1"># ca.crt</span>
</span></span><span class="line"><span class="cl"><span class="c1"># namespace</span>
</span></span><span class="line"><span class="cl"><span class="c1"># token</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="opaque-secret" class="heading-element">
  <a href="#opaque-secret" class="heading-mark"></a>Opaque Secret</h4><p>Opaque 类型的数据是一个 map 类型，要求 value 是 base64 编码格式</p>
<h5 id="创建-1" class="heading-element">
  <a href="#%e5%88%9b%e5%bb%ba-1" class="heading-mark"></a>创建</h5><div class="highlight" id="id-57"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">echo</span> -n <span class="s2">&#34;admin&#34;</span> <span class="p">|</span> base64
</span></span><span class="line"><span class="cl"><span class="nv">YWRtaW4</span><span class="o">=</span>
</span></span><span class="line"><span class="cl">$ <span class="nb">echo</span> -n <span class="s2">&#34;123456&#34;</span> <span class="p">|</span> base64
</span></span><span class="line"><span class="cl">MTIzNDU2</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>secrets.yaml</strong></p>
<div class="highlight" id="id-58"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Opaque</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">YWRtaW4=</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">MTIzNDU2</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>secret 在挂载后会自动解密</p>
</blockquote>
<h5 id="使用-1" class="heading-element">
  <a href="#%e4%bd%bf%e7%94%a8-1" class="heading-mark"></a>使用</h5><p><strong>1、将 Secret 挂载到 Volume 中</strong></p>
<div class="highlight" id="id-59"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secret-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">secret-test</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volumes12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">mysecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">myapp:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">db</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">volumes12</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/data&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2、将 Secret 导出到环境变量中</strong></p>
<div class="highlight" id="id-60"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">pod-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pod-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">myapp:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">TEST_USER</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">username</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">TEST_PASSWORD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mysecret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">password</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="kubernetesiodockerconfigjson" class="heading-element">
  <a href="#kubernetesiodockerconfigjson" class="heading-mark"></a>kubernetes.io/dockerconfigjson</h4><p>使用 kubectl 创建 docker 仓库认证的 secret</p>
<div class="highlight" id="id-61"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ kubectl create secret docker-registry myregistrykey <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--docker-server<span class="o">=</span>DOCKER_REGISTRY_SERVER <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--docker-username<span class="o">=</span>DOCKER_USER <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--docker-password<span class="o">=</span>DOCKER_PASSWOED <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--docker-email<span class="o">=</span>DOCKER_EMAIL
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">secret <span class="s2">&#34;myregistrykey&#34;</span> created。</span></span></code></pre></td></tr></table>
</div>
</div><p>在创建 Pod 的时候，通过 <code>imagePullSecrets</code>来引用刚创建的<code>myregistrykey</code></p>
<div class="highlight" id="id-62"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">foo</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">hub.xxx.com/xxx/xxxx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">imagePullSecrets</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">myregistrykey</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="volume卷" class="heading-element">
  <a href="#volume%e5%8d%b7" class="heading-mark"></a>Volume「卷」</h3><p>容器磁盘上的文件等生命周期是短暂的，这就使得在容器中运行重要应用时会出现一些问题。首先，当容器崩溃时，kubelet 会重启它，但是容器中的文件将丢失，容器将以干净的状态（镜像最初的状态）重新启动。其次，在<code>Pod</code>中同时运行多个容器时，这些容器之间通常需要共享文件。Kubernetes 中的 <code>Volume</code> 抽象就很好的解决了这些问题。</p>
<p>Kubernetes 中的卷有明确的寿命（与封装它的 Pod 相同）。所以，卷的生命比 Pod 中的所有容器都长，当这个容器重启时数据仍然得以保存。当然，当 Pod 不再存在时，卷也将不复存在。也许更重要的是，Kubernetes 支持多种类型的卷，Pod 可以同时使用任意数量的卷</p>
<p><strong>类型</strong></p>
<p>kubernetes 支持以下类型的卷：</p>
<ul>
<li><code>csi</code> 通用存储接口</li>
<li><code>hostPath</code> 主机路径（不能限制使用量）</li>
<li><code>emptyDir</code> 空目录</li>
<li><code>awsElasticBlockStore</code> <code>azureDisk</code> <code>azureFile</code> <code>cephfs</code>  <code>downwardAPI</code></li>
<li><code>fc</code> <code>flocker</code> <code>gcePersistentDisk</code> <code>gitRepo</code> <code>glusterfs</code> <code>hostPath</code> <code>iscsi</code> <code>local</code> <code>nfs</code></li>
<li><code>persistentVolumeClaim</code> <code>projected</code> <code>portworxVolume</code> <code>quobyte</code> <code>rbd</code> <code>scaleIO</code> <code>secret</code></li>
<li><code>storageos</code> <code>vsphereVolume</code></li>
</ul>
<h5 id="emptydir" class="heading-element">
  <a href="#emptydir" class="heading-mark"></a>emptyDir</h5><p>当 Pod 被分配给节点时，首先创建 <code>emptyDir</code> 卷，并且只要该 Pod 在该节点上运行，该卷就会存在。正如卷名字所述，它最初时空的。Pod 中的容器可以读取喝写入 <code>emptyDir</code> 卷中的相同文件，尽管该卷可以挂载到每个容器中的相同或不同路径上。当出于任何原因从节点中删除 Pod 时，<code>empryDir</code> 中的数据将被永久删除</p>
<p>⚠️<strong>注意：</strong> 容器崩溃不会从节点中移除 Pod，因此 <code>emptyDir</code> 卷中的数据在容器崩溃时是安全的</p>
<p>用法：</p>
<ul>
<li>暂存空间，例如用于基于磁盘的合并排序、用作长时间计算崩溃恢复时的检查点</li>
<li>Web 服务器容器提供数据时，保存内容管理器提取的文件</li>
</ul>
<div class="highlight" id="id-63"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">jobs-empty</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spce</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">initContainers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">job-1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.34.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;sh&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;-c&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="p">&gt;</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">              for i in 1 2 3;
</span></span></span><span class="line"><span class="cl"><span class="sd">              do
</span></span></span><span class="line"><span class="cl"><span class="sd">                echo &#34;job-1 `date`&#34;;
</span></span></span><span class="line"><span class="cl"><span class="sd">                sleep 1s;
</span></span></span><span class="line"><span class="cl"><span class="sd">              done;
</span></span></span><span class="line"><span class="cl"><span class="sd">              echo job-1 GG &gt; /src/input/code</span><span class="w">              
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"> </span><span class="c"># 挂载一个卷</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">input</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/src/input/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">job-2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.34.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;sh&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;-c&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="p">&gt;</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">              for i in 1 2 3;
</span></span></span><span class="line"><span class="cl"><span class="sd">              do
</span></span></span><span class="line"><span class="cl"><span class="sd">                echo &#34;job-2 `date`&#34;;
</span></span></span><span class="line"><span class="cl"><span class="sd">                sleep 1s;
</span></span></span><span class="line"><span class="cl"><span class="sd">              done;
</span></span></span><span class="line"><span class="cl"><span class="sd">              cat /src/input/code &amp;&amp;
</span></span></span><span class="line"><span class="cl"><span class="sd">              echo job-2 GG &gt; /sec/input/output/file</span><span class="w">              
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w"> </span><span class="c"># 挂载两个卷</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">input</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/src/input/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">output</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/src/input/output/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">job-3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.34.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;sh&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="s2">&#34;-c&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="p">&gt;</span><span class="sd">
</span></span></span><span class="line"><span class="cl"><span class="sd">              echo &#34;job-1 and job-2 completed&#34;;
</span></span></span><span class="line"><span class="cl"><span class="sd">              sleep 3s;
</span></span></span><span class="line"><span class="cl"><span class="sd">              cat /src/output/file</span><span class="w">              
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">output</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/src/output/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">input</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">output</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="hostpath" class="heading-element">
  <a href="#hostpath" class="heading-mark"></a>hostPath</h5><p><code>hostPath</code> 卷将主机节点的文件系统中的文件或目录挂载到集群中</p>
<p>用途如下：</p>
<ul>
<li>运行需要访问 Docker 内部的容器；使用 <code>/var/lib/docker</code> 的 <code>hostPath</code></li>
<li>在容器中运行 cAdvisor; 使用 <code>/dev/cgroups</code> 的 <code>hostPath</code></li>
<li>允许 Pod 指定给定的 hostPath 是否应该在 Pod 运行之前存在，是否应该创建，以及它应该以什么形式存在</li>
</ul>
<p>除了所需的 <code>path</code> 属性之外，用户还可以为 hostPath 卷指定 type</p>
<table>
<thead>
<tr>
<th>值</th>
<th>行为</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>空字符串（默认）用于向后兼容，这意味着在挂载 hostPath 卷之前不会执行任何检查</td>
</tr>
<tr>
<td><code>DirectoryOrCreate</code></td>
<td>如果在给定的路径没有任何东西存在，那么将根据需要在那里创建一个空目录，权限设置为 0755，与 kubelet 具有相同的组喝所有权</td>
</tr>
<tr>
<td><code>Directory</code></td>
<td>给定的路径下必须存在目录</td>
</tr>
<tr>
<td><code>FileOrCreate</code></td>
<td>如果在给定的路径没有任何东西存在，那么将根据需要在那里创建一个空文件，权限设置为 0655，与 kubelet 具有相同的组喝所有权</td>
</tr>
<tr>
<td><code>File</code></td>
<td>给定的路径下必须存在文件</td>
</tr>
<tr>
<td><code>Socket</code></td>
<td>给定的路径下必须存在 UNIX 套接字</td>
</tr>
<tr>
<td><code>CharDevice</code></td>
<td>给定的路径下必须存在字符设备</td>
</tr>
<tr>
<td><code>BlockDevice</code></td>
<td>给定的路径下必须存在块设备</td>
</tr>
</tbody>
</table>
<p>使用这种卷类型时请注意，因为：</p>
<ul>
<li>由于每个节点上的文件都不同，具有相同配置（例如从 PodTemplate 创建的）的 Pod 在不同节点上的行为会有所不同</li>
<li>当 Kubernetes 按照计划添加资源感知调度时，将无法考虑 <code>hostPath</code> 使用的资源</li>
<li>在底层主机上创建的文件或目录只能由 root 写入，您需要在特权容器中以 root 身份运行进程，或修改主机上的文件权限以便写入 hostPath 卷</li>
</ul>
<div class="highlight" id="id-64"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-pd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">myapp:v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-container</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/test-pd</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">test-volume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/data</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Dirctory</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="persistent-volume持久卷" class="heading-element">
  <a href="#persistent-volume%e6%8c%81%e4%b9%85%e5%8d%b7" class="heading-mark"></a>Persistent Volume「持久卷」</h3><h4 id="概念" class="heading-element">
  <a href="#%e6%a6%82%e5%bf%b5" class="heading-mark"></a>概念</h4><p><strong>PersistentVolume（PV）</strong></p>
<p>是由管理员设置的存储，它是集群的一部分，就像节点是集群中的资源一样，PV 也是集群中的资源。PV 是 Volume 之类的卷插件，但具有独立于使用 PV 的 Pod 的生命周期。此 API 对象包含存储实现的细节，即 NFS、ISCSI 或特定于云供应商的存储系统</p>
<p><strong>PersistentVolumeClaim（PVC）</strong></p>
<p>是用户存储的请求，它与 Pod 相似。Pod 消耗节点资源，PVC 消耗 PV 资源。Pod 可以请求特定级别的资源（CPU 和 内存）。声明可以请求特定的大小和访问模式（例如：可以以读/写一次或只读多次模式挂载）</p>
<p><strong>静态PV</strong></p>
<p>集群管理员创建一些 PV。它们带有可供集群用户使用的实际存储的细节。它们存在于 Kuberneters API 中，可用于消费。</p>
<p><strong>动态PV</strong></p>
<p>当管理员创建的静态 PV 都不匹配用户的 <code>PVC</code> 时，集群可能会尝试动态的为 PVC 创建卷。此配置基于 <code>StorageClasses</code>： PVC 必须请求 「存储类」，并且管理员必须创建并配置该类才能进行动态创建。声明该类为 <code>&quot;&quot;</code> 可以有效的禁用其动态配置</p>
<p>要启用基于存储级别的动态存储配置，集群管理员需要启用 API server 上的 <code>DefaultStorageClass</code>「准入控制器」。例如，通过确保 <code>DefaultStorageClass</code> 位于 API server 组件的 <code>--admission-control</code> 标志，使用逗号分隔的有序值列表中，可以完成此操作</p>
<h4 id="绑定" class="heading-element">
  <a href="#%e7%bb%91%e5%ae%9a" class="heading-mark"></a>绑定</h4><p>master 中的控制环路监听新的 PVC，寻找匹配的 PV（如果可能），并将它们绑定在一起。如果为新的 PVC 动态掉配 PV，则该环路将始终将 PV 绑定到 PVC，否则用户总会得到他们所请求的存储，但是容量可能超出要求的数量。一旦 PV 和 PVC 绑定后，<code>PersistentVolumeClaim</code> 绑定是排他性的，不管它们是如何绑定的。PVC 跟 PV 绑定是一对一的映射</p>
<h4 id="保护" class="heading-element">
  <a href="#%e4%bf%9d%e6%8a%a4" class="heading-mark"></a>保护</h4><p>PVC 保护的目的是确保由 Pod 正在使用的 PVC 不会从系统中移除，因为如果被移除的话可能会导致数据丢失</p>
<p>⚠️**注意：**当 Pod 状态为 <code>Pending</code> 并且 Pod 已经分配给节点或 Pod 为 <code>Running</code> 状态时，PVC处于活跃状态</p>
<p>当启用 PVC 保护 alpha 功能时，如果用户删除了一个 Pod 正在使用的 PVC，则该 PVC 不会被立即删除。PVC 的删除将被推迟，直到 PVC 不再被任何 Pod 使用</p>
<h4 id="分类" class="heading-element">
  <a href="#%e5%88%86%e7%b1%bb" class="heading-mark"></a>分类</h4><p><code>PersistentVolume</code> 类型以插件形式出现。Kubernetes 目前支持以下插件类型：</p>
<ul>
<li><code>HostPath</code></li>
<li><code>GCEPersistentDisk</code> <code>AWSElasticBlockStore</code> <code>AzureFile</code> <code>AzureDisk</code> <code>FC(Fibre Channel)</code></li>
<li><code>FlexVolume</code> <code>Flocker</code> <code>NFS</code> <code>iSCSI</code> <code>RBD</code> <code>CephFS</code> <code>Cinder(OpenStack block storage)</code></li>
<li><code>Glusterfs</code> <code>VsphereVolume</code> <code>Quobyte Volumes</code> <code>Vmware Photon</code> <code>Portworx Voumes</code></li>
<li><code>ScaleIO Volumes</code> <code>StorageOS</code></li>
</ul>
<p><strong>持久卷示例代码</strong></p>
<div class="highlight" id="id-65"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PersistentVolume</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pv0001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">capacity</span><span class="p">:</span><span class="w"> </span><span class="c"># 容量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l">5Gi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumeMode</span><span class="p">:</span><span class="w"> </span><span class="l">Filesystem</span><span class="w"> </span><span class="c"># 卷模式</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span><span class="w"> </span><span class="c"># 访问策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">ReadWriteOnce</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">persistentVolumeReclaimPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Recycle</span><span class="w"> </span><span class="c"># 回收策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l">slow</span><span class="w"> </span><span class="c"># 存储类名称 默认为 StorageClass</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">mountOptions</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">hard</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">nfsvers=4.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">nfs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="m">172.17.0.2</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="访问模式" class="heading-element">
  <a href="#%e8%ae%bf%e9%97%ae%e6%a8%a1%e5%bc%8f" class="heading-mark"></a>访问模式</h4><p>PV 可以以资源提供者支持的任何形式挂载到主机上。如下表所示，供应商具有不同的功能，每个 PV 的访问模式都将被设置为该卷支持的特定模式。例如，NFS 可以支持多个读/写客户端，但特定的 NFS PV 可能以只读方式导出到服务器上。每个 PV 都有一套自己的用来描述特定功能的访问模式</p>
<ul>
<li><strong>ReadWriteOnce</strong> 该卷可以被单个节点以读/写模式挂载</li>
<li><strong>ReadOnlyMany</strong> 该卷可以被多个节点以只读模式挂载</li>
<li><strong>ReadWriteMany</strong> 该卷可以被多个节点以读/写模式挂载</li>
</ul>
<p><strong>在命令行中，访问模式缩写为：</strong></p>
<ul>
<li><strong>RWO</strong> - ReadWriteOnce</li>
<li><strong>ROX</strong> - ReadOnlyMany</li>
<li><strong>ReadWriteMany</strong> - RWX</li>
</ul>
<p>⚠️**注意：**一个卷一次只能使用一种访问模式挂载，即使它支持很多访问模式。例如，GCRPersistentDisk 可以由单个节点作为 ReadWriteOnce 模式挂载，或由多个节点以 ReadOnlyMany 模式挂载，但不能同时挂载</p>
<h4 id="回收策略" class="heading-element">
  <a href="#%e5%9b%9e%e6%94%b6%e7%ad%96%e7%95%a5" class="heading-mark"></a>回收策略</h4><ul>
<li>Retain（保留）：手动回收</li>
<li>Recycle（回收）：基本擦除（<code>rm -rf /thevolume/*</code>）</li>
<li>Delete（删除）：关联的存储资产（例如 AWS EBS&hellip;）将被删除</li>
</ul>
<p>当前，只有 HostPath 支持回收策略，AWS EBS、GCE PD、Azure Disk 和 Cinder 卷支持删除策略</p>
<h4 id="状态" class="heading-element">
  <a href="#%e7%8a%b6%e6%80%81" class="heading-mark"></a>状态</h4><p>卷可以处于一下的某种状态：</p>
<ul>
<li>Available（可用）：一块空闲资源还没有被任何声明绑定</li>
<li>Bound（已绑定）：卷已经被声明绑定</li>
<li>Released（已释放）：声明被删除，但是资源还未被集群重新声明</li>
<li>Failed（失败）：该卷的自动回收失败</li>
</ul>
<p>命令行会显示绑定到 PV 的 PVC 的名称</p>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2022-06-07 10:45:00">更新于 2022-06-07&nbsp;</span>
      </div><div class="post-info-license">
            <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span>
          </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/posts/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span><span><a href="https://github.com/RoninZc/RoninZc.github.io.git/blob/main/content/posts/K8S/K8S%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0.md?plain=1" title="查看源码"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-source">查看源码</a></span><span><a href="https://github.com/RoninZc/RoninZc.github.io.git/edit/main/content/posts/K8S/K8S%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0.md" title="编辑此页"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-edit">编辑此页</a></span><span><a href="https://github.com/RoninZc/RoninZc.github.io.git/issues/new?title=[BUG]%20K8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7cK8S%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%7c%0A%7cURL%7chttps://ronin-zc.com/posts/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%7c%0A%7cFilename%7chttps://github.com/RoninZc/RoninZc.github.io.git/blob/main/content/posts/K8S/K8S%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0.md?plain=1%7c" title="报告问题"target="_blank" rel="external nofollow noopener noreferrer" class="link-to-report">报告问题</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://ronin-zc.com/posts/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="K8S学习笔记" data-hashtags="k8s"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://ronin-zc.com/posts/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-hashtag="k8s"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://ronin-zc.com/posts/k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="K8S学习笔记"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/k8s/" class="post-tag" title="标签 - K8s">K8s</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94%E8%BD%AC%E8%BD%BD/" class="post-nav-item" rel="prev" title="MySQL动态存储方案对比「转」"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>MySQL动态存储方案对比「转」</a>
      <a href="/posts/docker%E9%83%A8%E7%BD%B2nginx%E5%87%BA%E7%8E%B0host-not-found-in-upstream%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" class="post-nav-item" rel="next" title="Docker 部署 Nginx 出现「host not found in upstream」问题解决">Docker 部署 Nginx 出现「host not found in upstream」问题解决<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="gitalk" class="comment"></div><noscript>
        Please enable JavaScript to view the comments powered by <a href="https://github.com/gitalk/gitalk" rel="external nofollow noopener noreferrer">Gitalk</a>.
      </noscript></div></article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.128.0"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/">RoninZc</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中……'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div><div class="footer-line beian"><span class="icp footer-divider"><a href="https://beian.miit.gov.cn/">赣ICP备18014838号</a></span></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><a href="https://github.com/RoninZc/RoninZc.github.io" title="在 GitHub 上查看源代码"target="_blank" rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/gitalk/gitalk.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><link rel="stylesheet" href="/lib/pace/themes/blue/pace-theme-minimal.css"><script src="/lib/gitalk/gitalk.min.js"></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script src="/lib/pace/pace.min.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":true,"expired":false,"gitalk":{"admin":["RoninZc"],"clientID":"9c7b40a3888f1e78b982","clientSecret":"735c7f29eddf00774f46187ff25824109753fb3a","id":"2022-06-07T10:45:00+08:00","owner":"RoninZc","repo":"RoninZc.github.io","title":"K8S学习笔记"}},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"typeit-header-subtitle-desktop":"Just do it","typeit-header-subtitle-mobile":"Just do it"},"enablePWA":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"siteTime":"2021-11-01T00:00:00+08:00","typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-header-subtitle-desktop":["typeit-header-subtitle-desktop"],"typeit-header-subtitle-mobile":["typeit-header-subtitle-mobile"]},"duration":-1,"loop":false,"speed":100}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
